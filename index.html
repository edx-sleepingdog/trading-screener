<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Signal Screener & Journal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; }
        .tab-active { border-bottom: 3px solid #3b82f6; color: #3b82f6; }
        .signal-card { transition: all 0.2s; }
        .signal-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.4); }

        /* Dark mode overrides */
        .bg-white { background-color: #1e2533 !important; }
        .bg-gray-50 { background-color: #161c27 !important; }
        .bg-gray-100 { background-color: #1a2030 !important; }
        .bg-gray-300 { background-color: #374151 !important; }
        .bg-blue-50   { background-color: #0d1f33 !important; }
        .bg-red-50    { background-color: #2a0d0d !important; }
        .bg-green-50  { background-color: #0d2011 !important; }
        .bg-yellow-50 { background-color: #2a2205 !important; }
        .bg-orange-50 { background-color: #2a1500 !important; }
        .bg-purple-50 { background-color: #1a0d2a !important; }
        .text-gray-600 { color: #a0aec0 !important; }
        .text-gray-500 { color: #8a97a8 !important; }
        .text-gray-700 { color: #cbd5e0 !important; }
        .text-gray-800 { color: #e2e8f0 !important; }
        .text-gray-900 { color: #f7fafc !important; }
        .text-red-700  { color: #fc8181 !important; }
        .border { border-color: #2d3748 !important; }
        .border-b { border-color: #2d3748 !important; }
        .border-t { border-color: #2d3748 !important; }
        input, select, textarea { background-color: #2d3748 !important; color: #e2e8f0 !important; border-color: #4a5568 !important; }
        input::placeholder, textarea::placeholder { color: #718096 !important; }
        .shadow-md { box-shadow: 0 4px 12px rgba(0,0,0,0.4) !important; }
    </style>
    <link rel="apple-touch-icon" href="data:image/png;base64,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">
    <link rel="icon" type="image/png" href="data:image/png;base64,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">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Sleeping Dog">
</head>
<body class="bg-gray-900 text-gray-100">
    <div class="max-w-7xl mx-auto p-4">
        <!-- Header -->
        <div class="rounded-lg shadow-md p-6 mb-4" style="background: linear-gradient(135deg, #a8d5b5 0%, #b8dfc4 60%, #ccebd6 100%);">
            <h1 class="text-3xl font-bold mb-1" style="color: #1a4a35;">Inside View</h1>
            <p style="color: #2d6e52; font-size: 0.85rem;">What You See Is All There Is</p>
        </div>

        <!-- Outside View: Sector RS Panel -->
        <div class="rounded-lg shadow-md mb-6 p-4" style="background: #161c27; border: 1px solid #2d3748;">
            <div class="flex items-center justify-between mb-3">
                <div>
                    <h2 class="text-sm font-bold text-cyan-300 uppercase tracking-widest">Outside View</h2>
                    <p class="text-xs text-gray-400 mt-0.5">Sector RS vs SPY ‚Äî Reference Class</p>
                </div>
                <div class="flex items-center gap-3">
                    <span id="sectorTimestamp" class="text-xs text-gray-500"></span>
                    <button onclick="loadSectorRS()" id="sectorRefreshBtn" class="text-xs bg-cyan-900 text-cyan-300 px-3 py-1 rounded hover:bg-cyan-800 transition">‚Üª Refresh</button>
                </div>
            </div>
            <div id="sectorRSContent">
                <div id="sectorLoading" class="text-center py-4 text-gray-500 text-sm">Loading sector data‚Ä¶</div>
                <table id="sectorTable" class="w-full text-sm hidden">
                    <thead>
                        <tr class="text-xs text-gray-400 border-b border-gray-700">
                            <th class="text-left pb-2 font-medium">Rank</th>
                            <th class="text-left pb-2 font-medium">Sector</th>
                            <th class="text-left pb-2 font-medium">ETF</th>
                            <th class="text-right pb-2 font-medium">4-Week RS</th>
                            <th class="text-right pb-2 font-medium">13-Week RS</th>
                            <th class="text-right pb-2 font-medium">Mom</th>
                        </tr>
                    </thead>
                    <tbody id="sectorTableBody"></tbody>
                </table>
                <div id="sectorError" class="hidden text-center py-4 text-red-400 text-sm"></div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="bg-white rounded-lg shadow-md mb-6">
            <div class="flex border-b">
                <button onclick="switchTab('screener')" id="tab-screener" class="tab-active px-2 py-2 font-medium text-sm flex-1 text-center leading-tight">
                    Screen
                </button>
                <button onclick="switchTab('calculator')" id="tab-calculator" class="px-2 py-2 font-medium text-sm text-gray-600 flex-1 text-center leading-tight">
                    Position<br>Sizer
                </button>
                <button onclick="switchTab('journal')" id="tab-journal" class="px-2 py-2 font-medium text-sm text-gray-600 flex-1 text-center leading-tight">
                    Trade<br>Journal
                </button>
                <button onclick="switchTab('rules')" id="tab-rules" class="px-2 py-2 font-medium text-sm text-gray-600 flex-1 text-center leading-tight">
                    Trading<br>Rules
                </button>
            </div>

            <!-- Screener Tab -->
            <div id="content-screener" class="p-6">
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Direction</label>
                        <select id="scanDirection" class="w-full p-2 border rounded">
                            <option value="long">Long (Pullbacks)</option>
                            <option value="short">Short (Breakdowns)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Account Size ($)</label>
                        <input type="number" id="accountSize" value="3214" class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Risk Mode</label>
                        <select id="riskMode" class="w-full p-2 border rounded">
                            <option value="1">Conservative (1% per trade)</option>
                            <option value="2">Moderate (2% per trade)</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <div class="w-full">
                            <label class="block text-sm font-medium mb-2">Risk per Trade</label>
                            <div class="w-full p-2 border rounded bg-gray-50" id="riskDisplay">$32.14</div>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Symbols to Scan</label>
                    <div class="flex gap-2 mb-2 flex-wrap">
                        <select id="watchlistSelect" class="flex-1 p-2 border rounded text-sm" onchange="loadWatchlist()">
                            <option value="">-- Load a saved watchlist --</option>
                        </select>
                        <button onclick="saveWatchlist()" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">Save</button>
                        <button onclick="deleteWatchlist()" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">Delete</button>
                    </div>
                    <textarea id="symbolInput" rows="3" placeholder="Paste tickers here: AAPL, MSFT, NVDA, XLI, XLU, NEE, CAT, etc. ‚Äî paste as many as you want, comma-separated" class="w-full p-2 border rounded text-sm font-mono"></textarea>
                    <p class="text-xs text-gray-500 mt-1">Tip: Type a name in the box above, enter your tickers, then hit Save to store as a named watchlist.</p>
                </div>

                <div class="flex gap-3 items-center flex-wrap">
                    <button onclick="scanMarket()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                        Scan for Signals
                    </button>
                    <label class="flex items-center gap-2 text-sm text-gray-600 cursor-pointer">
                        <input type="checkbox" id="diagnosticMode" class="w-4 h-4">
                        Diagnostic mode (show raw data for all symbols)
                    </label>
                </div>

                <div id="scanningStatus" class="hidden mt-4 p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded">
                    <p class="text-sm font-medium">Scanning market data... this may take a moment.</p>
                </div>

                <div id="signalResults" class="mt-6 space-y-4">
                    <!-- Signals will appear here -->
                </div>
            </div>

            <!-- Calculator Tab -->
            <div id="content-calculator" class="p-6 hidden">
                <h2 class="text-xl font-bold mb-4">Position Size Calculator</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Symbol</label>
                            <input type="text" id="calcSymbol" class="w-full p-2 border rounded" placeholder="e.g., AAPL">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Entry Price ($)</label>
                            <input type="number" id="calcEntry" step="0.01" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Stop Loss ($)</label>
                            <input type="number" id="calcStop" step="0.01" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Account Size ($)</label>
                            <input type="number" id="calcAccount" value="3214" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Risk per Trade (%)</label>
                            <input type="number" id="calcRisk" value="1" step="0.1" class="w-full p-2 border rounded">
                        </div>
                        <button onclick="calculatePosition()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 w-full">
                            Calculate Position
                        </button>
                    </div>
                    <div id="calcResults" class="bg-gray-50 p-6 rounded-lg">
                        <h3 class="font-bold mb-4">Results</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Risk Amount:</span>
                                <span id="riskAmount" class="font-bold">$0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Risk per Share:</span>
                                <span id="riskPerShare" class="font-bold">$0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Position Size:</span>
                                <span id="positionSize" class="font-bold">0 shares</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Position Value:</span>
                                <span id="positionValue" class="font-bold">$0.00</span>
                            </div>
                            <div class="flex justify-between pt-3 border-t">
                                <span class="text-gray-600">2R Mgmt Level:</span>
                                <span id="target2R" class="font-bold text-green-600">$0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Breakeven Move:</span>
                                <span id="breakeven" class="font-bold text-blue-600">$0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Journal Tab -->
            <div id="content-journal" class="p-6 hidden">
                <h2 class="text-xl font-bold mb-4">Trade Journal</h2>

                <!-- Stats & Goal Tracker -->
                <div id="journalTracker" class="rounded-lg p-4 mb-5" style="background:#0d1a2a; border:1px solid #1e3a5f;">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                        <div class="text-center">
                            <div class="text-xs text-gray-400 mb-1">Streak</div>
                            <div id="trackerStreak" class="text-2xl font-bold">‚Äî</div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs text-gray-400 mb-1">Total R</div>
                            <div id="trackerR" class="text-2xl font-bold">‚Äî</div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs text-gray-400 mb-1">Trades</div>
                            <div id="trackerCount" class="text-2xl font-bold">‚Äî</div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs text-gray-400 mb-1">Win Rate</div>
                            <div id="trackerWinRate" class="text-2xl font-bold">‚Äî</div>
                        </div>
                    </div>
                    <!-- Goal bar -->
                    <div class="mb-3">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs text-gray-400">Next unlock at <span id="trackerUnlockTarget" class="text-blue-400 font-medium">$4,000</span></span>
                            <div class="flex items-center gap-2">
                                <span id="trackerGoalLabel" class="text-xs text-gray-300"></span>
                                <button onclick="editGoal()" class="text-xs text-blue-400 hover:text-blue-300 underline">edit</button>
                            </div>
                        </div>
                        <div class="w-full rounded-full h-3" style="background:#1e3a5f;">
                            <div id="trackerBar" class="h-3 rounded-full transition-all" style="background: linear-gradient(90deg, #3b82f6, #10b981); width:0%"></div>
                        </div>
                        <div id="trackerBarLabel" class="text-xs text-gray-400 mt-1"></div>
                    </div>
                    <!-- Cumulative R bar -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs text-gray-400">Cumulative R</span>
                            <span id="trackerRBarLabel" class="text-xs text-gray-300"></span>
                        </div>
                        <div class="w-full rounded-full h-3" style="background:#1e2a1e;">
                            <div id="trackerRBar" class="h-3 rounded-full transition-all" style="background: linear-gradient(90deg, #10b981, #34d399); width:0%"></div>
                        </div>
                        <div id="trackerRBarSub" class="text-xs text-gray-500 mt-1"></div>
                        <div id="trackerRiskDeployed" class="text-xs text-gray-500 mt-1"></div>
                    </div>
                </div>

                <div class="mb-6 flex gap-3 flex-wrap">
                    <button onclick="showAddTrade()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                        + Add Trade
                    </button>
                    <button onclick="toggleReviewMode()" id="reviewModeBtn" class="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700">
                        üîç Review Passes
                    </button>
                    <button onclick="exportTrades()" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">
                        üì• Export CSV
                    </button>
                    <button onclick="exportBackupJSON()" class="bg-teal-600 text-white px-6 py-2 rounded hover:bg-teal-700">
                        üíæ Backup JSON
                    </button>
                    <button onclick="document.getElementById('importFile').click()" class="bg-purple-600 text-white px-6 py-2 rounded hover:bg-purple-700">
                        üì§ Import Backup
                    </button>
                    <input type="file" id="importFile" accept=".json" style="display: none" onchange="importTrades(event)">
                </div>

                <!-- Add Trade Form -->
                <div id="addTradeForm" class="hidden bg-gray-50 p-6 rounded-lg mb-6">
                    <h3 class="font-bold mb-4">New Trade Entry</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Symbol</label>
                            <input type="text" id="tradeSymbol" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Direction</label>
                            <select id="tradeDirection" class="w-full p-2 border rounded">
                                <option value="Long">Long</option>
                                <option value="Short">Short</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Entry Date</label>
                            <input type="date" id="tradeDate" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Entry Price</label>
                            <input type="number" id="tradeEntry" step="0.01" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Stop Loss</label>
                            <input type="number" id="tradeStop" step="0.01" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Position Size (shares)</label>
                            <input type="number" id="tradeShares" class="w-full p-2 border rounded">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">Setup Notes</label>
                        <textarea id="tradeNotes" rows="3" class="w-full p-2 border rounded" placeholder="What made this a good setup? What was the thesis?"></textarea>
                    </div>
                    <div class="mb-4 flex items-center gap-2">
                        <input type="checkbox" id="tradeLegacy" class="w-4 h-4">
                        <label for="tradeLegacy" class="text-sm text-gray-400">Pre-screener trade ‚Äî show in positions but exclude from stats &amp; review</label>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="saveTrade()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                            Save Trade
                        </button>
                        <button onclick="cancelAddTrade()" class="bg-gray-300 text-gray-700 px-6 py-2 rounded hover:bg-gray-400">
                            Cancel
                        </button>
                    </div>
                </div>

                <!-- Open Positions Panel ‚Äî always visible -->
                <div id="openPositionsPanel" class="hidden mb-6">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="text-sm font-bold text-blue-300 uppercase tracking-wide">‚óè Open Positions</span>
                        <span id="openPositionsCount" class="text-xs bg-blue-900 text-blue-300 px-2 py-0.5 rounded-full font-medium"></span>
                    </div>
                    <div id="openPositionsList" class="space-y-2"></div>
                </div>

                <!-- Trade List -->
                <div id="tradeList" class="space-y-4">
                    <!-- Trades will appear here -->
                </div>
            </div>

            <!-- Rules Tab -->
            <div id="content-rules" class="p-6 hidden">
                <h2 class="text-xl font-bold mb-4">Trading System Rules</h2>
                
                <div class="space-y-6">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-bold mb-2">üìä LONG Entry Setup (All Must Be True)</h3>
                        <ul class="list-disc list-inside space-y-1 text-sm">
                            <li>Price pulls back to or pushes through 20 SMA</li>
                            <li>Stock must be in uptrend (20 > 50 > 200 SMAs)</li>
                            <li>Price within 20% of 200 SMA (not overextended)</li>
                            <li>Relative strength vs SPY positive (outperforming)</li>
                            <li>Sector showing momentum (accelerating strength)</li>
                            <li><strong>Volume confirmation:</strong> Pullback on below-average volume, entry day on above-average volume</li>
                            <li>No earnings within 7 days (before or after)</li>
                        </ul>
                    </div>

                    <div class="bg-red-50 p-4 rounded-lg">
                        <h3 class="font-bold mb-2">üìâ SHORT Entry Setup (All Must Be True)</h3>
                        <ul class="list-disc list-inside space-y-1 text-sm">
                            <li>Price below 200 SMA (broken long-term support)</li>
                            <li>Stock must be in downtrend (20 < 50 < 200 SMAs)</li>
                            <li>Failed rally to 20 SMA (price near but can't break above)</li>
                            <li>Relative weakness vs SPY negative (underperforming)</li>
                            <li>Sector showing weakness</li>
                            <li><strong>Volume confirmation:</strong> Increased volume on down days</li>
                            <li>No earnings within 7 days (avoid binary events)</li>
                        </ul>
                        <p class="text-xs mt-2 text-red-700 font-medium">‚ö†Ô∏è SHORT WARNING: Unlimited risk - be extra strict with 1% rule. Watch for short squeezes around rallies.</p>
                    </div>

                    <div class="bg-green-50 p-4 rounded-lg">
                        <h3 class="font-bold mb-2">üí∞ Position Sizing (SAME FOR LONGS & SHORTS)</h3>
                        <ul class="list-disc list-inside space-y-1 text-sm">
                            <li>Risk 1% of account per trade (conservative mode)</li>
                            <li>Can increase to 2% once confident with 50+ trades logged</li>
                            <li>Stop loss = 2x ATR(20) from entry</li>
                            <li>Position size = (Account √ó Risk%) √∑ (Entry - Stop)</li>
                        </ul>
                    </div>

                    <div class="bg-yellow-50 p-4 rounded-lg">
                        <h3 class="font-bold mb-2">üéØ LONG Exit Management</h3>
                        <ul class="list-disc list-inside space-y-1 text-sm">
                            <li>Hold position to +2R target</li>
                            <li>At +2R: Move stop to breakeven (entry price) ‚Äî trade is now free</li>
                            <li>After hitting +2R: Trail stop at 20 SMA - 1 ATR</li>
                            <li>Exit on stop hit or trend break (price crosses below 20 SMA by more than 1 ATR)</li>
                        </ul>
                    </div>

                    <div class="bg-orange-50 p-4 rounded-lg">
                        <h3 class="font-bold mb-2">üéØ SHORT Exit Management</h3>
                        <ul class="list-disc list-inside space-y-1 text-sm">
                            <li>Hold position to +2R target (price moves DOWN 2R)</li>
                            <li>At +2R: Move stop to breakeven (entry price) ‚Äî trade is now free</li>
                            <li>After hitting +2R: Trail stop at 20 SMA + 1 ATR</li>
                            <li>Exit on stop hit or trend reversal (price breaks above 20 SMA by more than 1 ATR)</li>
                            <li><strong>Critical:</strong> Cover shorts immediately on big market rallies - don't fight the tape</li>
                        </ul>
                    </div>

                    <div class="bg-red-50 p-4 rounded-lg">
                        <h3 class="font-bold mb-2">üõë Risk Rules</h3>
                        <ul class="list-disc list-inside space-y-1 text-sm">
                            <li>Never exceed risk limit per trade (1% or 2%)</li>
                            <li>Maximum 5 concurrent positions TOTAL (longs + shorts combined)</li>
                            <li>No more than 2 positions in same sector</li>
                            <li>Maximum 2 short positions at any time (shorts are higher risk)</li>
                            <li>If 3 consecutive losses, reduce position size by 50% for next 3 trades</li>
                            <li>Never short into strong market rallies - wait for weakness</li>
                        </ul>
                    </div>

                    <div class="bg-purple-50 p-4 rounded-lg">
                        <h3 class="font-bold mb-2">üß† Execution Workflow</h3>
                        <ul class="list-disc list-inside space-y-1 text-sm">
                            <li><strong>After market close:</strong> Run screener for both longs and shorts, review signals, make watchlist</li>
                            <li><strong>Next morning (first 30-60 min):</strong> Watch how signals develop</li>
                            <li><strong>Discretion check:</strong> Does setup still look good? Any overnight news? Pattern still clean?</li>
                            <li><strong>For shorts specifically:</strong> Check short interest (avoid high short interest), check if stock is "hard to borrow"</li>
                            <li><strong>Execute:</strong> If yes, enter manually. If no, pass without regret.</li>
                            <li><strong>Journal it:</strong> Write down why you took or passed on each signal</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize
        document.getElementById('tradeDate').valueAsDate = new Date();
        let trades = JSON.parse(localStorage.getItem('trades') || '[]');
        let decisions = JSON.parse(localStorage.getItem('decisions') || '[]');

        // Restore saved settings
        const savedAccount = localStorage.getItem('accountSize');
        const savedRisk = localStorage.getItem('riskMode');
        if (savedAccount) document.getElementById('accountSize').value = savedAccount;
        if (savedRisk) document.getElementById('riskMode').value = savedRisk;

        // Persist settings on change
        document.getElementById('accountSize').addEventListener('input', () => {
            const val = parseFloat(document.getElementById('accountSize').value) || 0;
            localStorage.setItem('accountSize', document.getElementById('accountSize').value);
            goalSettings.currentSize = val;
            localStorage.setItem('goalSettings', JSON.stringify(goalSettings));
            updateRiskDisplay();
        });
        document.getElementById('riskMode').addEventListener('change', () => {
            localStorage.setItem('riskMode', document.getElementById('riskMode').value);
            updateRiskDisplay();
        });

        // Watchlist functions
        function getWatchlists() {
            return JSON.parse(localStorage.getItem('watchlists') || '{}');
        }
        function refreshWatchlistDropdown() {
            const sel = document.getElementById('watchlistSelect');
            const lists = getWatchlists();
            const current = sel.value;
            sel.innerHTML = '<option value="">-- Load a saved watchlist --</option>';
            Object.keys(lists).sort().forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                opt.textContent = name + ' (' + lists[name].split(',').filter(s=>s.trim()).length + ' symbols)';
                sel.appendChild(opt);
            });
            if (current && lists[current]) sel.value = current;
        }
        function loadWatchlist() {
            const name = document.getElementById('watchlistSelect').value;
            if (!name) return;
            const lists = getWatchlists();
            if (lists[name]) document.getElementById('symbolInput').value = lists[name];
        }
        function saveWatchlist() {
            const symbols = document.getElementById('symbolInput').value.trim();
            if (!symbols) { alert('Enter some symbols first.'); return; }
            const name = prompt('Name this watchlist:');
            if (!name || !name.trim()) return;
            const lists = getWatchlists();
            lists[name.trim()] = symbols;
            localStorage.setItem('watchlists', JSON.stringify(lists));
            refreshWatchlistDropdown();
            document.getElementById('watchlistSelect').value = name.trim();
        }
        function deleteWatchlist() {
            const name = document.getElementById('watchlistSelect').value;
            if (!name) { alert('Select a watchlist to delete.'); return; }
            if (!confirm('Delete "' + name + '"?')) return;
            const lists = getWatchlists();
            delete lists[name];
            localStorage.setItem('watchlists', JSON.stringify(lists));
            refreshWatchlistDropdown();
        }
        refreshWatchlistDropdown();

        // Update risk display on load

        function updateRiskDisplay() {
            const account = parseFloat(document.getElementById('accountSize').value) || 0;
            const riskPct = parseFloat(document.getElementById('riskMode').value) || 1;
            const riskAmt = account * (riskPct / 100);
            document.getElementById('riskDisplay').textContent = '$' + riskAmt.toFixed(2);
        }

        function switchTab(tab) {
            ['screener', 'calculator', 'journal', 'rules'].forEach(t => {
                document.getElementById('content-' + t).classList.add('hidden');
                document.getElementById('tab-' + t).classList.remove('tab-active', 'text-blue-600');
                document.getElementById('tab-' + t).classList.add('text-gray-600');
            });
            
            document.getElementById('content-' + tab).classList.remove('hidden');
            document.getElementById('tab-' + tab).classList.add('tab-active', 'text-blue-600');
            document.getElementById('tab-' + tab).classList.remove('text-gray-600');

            if (tab === 'journal') {
                renderTrades();
            }
        }

        // Calculate SMA
        function calculateSMA(prices, period) {
            if (prices.length < period) return null;
            const slice = prices.slice(-period);
            return slice.reduce((sum, p) => sum + p, 0) / period;
        }

        // Calculate ATR
        function calculateATR(highs, lows, closes, period) {
            if (highs.length < period + 1) return null;
            
            let trueRanges = [];
            for (let i = 1; i < highs.length; i++) {
                const high = highs[i];
                const low = lows[i];
                const prevClose = closes[i - 1];
                
                const tr = Math.max(
                    high - low,
                    Math.abs(high - prevClose),
                    Math.abs(low - prevClose)
                );
                trueRanges.push(tr);
            }
            
            const recentTR = trueRanges.slice(-period);
            return recentTR.reduce((sum, tr) => sum + tr, 0) / period;
        }

        async function fetchYahooData(symbol) {
            try {
                const period1 = Math.floor(Date.now() / 1000) - (400 * 24 * 60 * 60);
                const period2 = Math.floor(Date.now() / 1000);
                const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?period1=${period1}&period2=${period2}&interval=1d`;
                const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(yahooUrl)}`;

                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();

                if (!data.chart || !data.chart.result || !data.chart.result[0]) {
                    return null;
                }

                const result = data.chart.result[0];
                const quotes = result.indicators.quote[0];

                return {
                    symbol: symbol,
                    closes: quotes.close.filter(c => c !== null),
                    highs: quotes.high.filter(h => h !== null),
                    lows: quotes.low.filter(l => l !== null),
                    volumes: quotes.volume.filter(v => v !== null),
                    timestamps: result.timestamp
                };
            } catch (error) {
                console.error(`Error fetching ${symbol}:`, error);
                return null;
            }
        }


        async function scanMarket() {
            const symbolInput = document.getElementById('symbolInput').value.trim();
            if (!symbolInput) {
                alert('Please enter symbols to scan');
                return;
            }

            const symbols = symbolInput.split(',').map(s => s.trim().toUpperCase()).filter(s => s);
            const accountSize = parseFloat(document.getElementById('accountSize').value);
            const riskPercent = parseFloat(document.getElementById('riskMode').value);
            const direction = document.getElementById('scanDirection').value;

            document.getElementById('scanningStatus').classList.remove('hidden');
            document.getElementById('signalResults').innerHTML = '';

            const results = [];
            const pipeline = [];
            const diagnostics = [];
            const diagnostic = document.getElementById('diagnosticMode').checked;

            // Fetch SPY for relative strength comparison
            const spyData = await fetchYahooData('SPY');
            let spyReturn = 0;
            if (spyData && spyData.closes.length >= 20) {
                spyReturn = ((spyData.closes[spyData.closes.length - 1] - spyData.closes[spyData.closes.length - 20]) / 
                            spyData.closes[spyData.closes.length - 20]) * 100;
            }

            for (const symbol of symbols) {
                // Rate limit: ~50 calls/min to stay under Finnhub free tier
                if (symbols.indexOf(symbol) > 0 && symbols.indexOf(symbol) % 50 === 0) {
                    document.getElementById('scanningStatus').querySelector('p').textContent = `Pausing briefly to respect API rate limit... (${symbols.indexOf(symbol)}/${symbols.length} scanned)`;
                    await new Promise(r => setTimeout(r, 65000));
                    document.getElementById('scanningStatus').querySelector('p').textContent = 'Scanning market data... this may take a moment.';
                }
                document.getElementById('scanningStatus').querySelector('p').textContent = `Scanning ${symbol} (${symbols.indexOf(symbol)+1}/${symbols.length})...`;
                const data = await fetchYahooData(symbol);
                if (!data) {
                    if (diagnostic) diagnostics.push({ symbol, status: '‚ùå Fetch failed', price: '-', sma20: '-', sma50: '-', sma200: '-', volRatio: '-', rs: '-', score: '-' });
                    continue;
                }

                const closes = data.closes;
                const highs = data.highs;
                const lows = data.lows;
                const volumes = data.volumes;

                if (closes.length < 200) {
                    if (diagnostic) diagnostics.push({ symbol, status: `‚ö†Ô∏è Only ${closes.length} days history`, price: closes[closes.length-1]?.toFixed(2) || '-', sma20: '-', sma50: '-', sma200: '-', volRatio: '-', rs: '-', score: '-' });
                    continue;
                }

                // Calculate indicators
                const currentPrice = closes[closes.length - 1];
                const sma20 = calculateSMA(closes, 20);
                const sma50 = calculateSMA(closes, 50);
                const sma200 = calculateSMA(closes, 200);
                const atr = calculateATR(highs, lows, closes, 20);

                if (!sma20 || !sma50 || !sma200 || !atr) {
                    if (diagnostic) diagnostics.push({ symbol, status: '‚ö†Ô∏è Indicator calc failed', price: currentPrice.toFixed(2), sma20: '-', sma50: '-', sma200: '-', volRatio: '-', rs: '-', score: '-' });
                    continue;
                }

                // Calculate average volume
                const avgVolume = volumes.slice(-20).reduce((sum, v) => sum + v, 0) / 20;
                const currentVolume = volumes[volumes.length - 1];
                const prevVolume = volumes[volumes.length - 2];

                // Calculate relative strength
                const stockReturn = ((closes[closes.length - 1] - closes[closes.length - 20]) / 
                                    closes[closes.length - 20]) * 100;
                const relativeStrength = stockReturn - spyReturn;

                let checks, stop, pattern;

                if (direction === 'long') {
                    // LONG CRITERIA
                    checks = {
                        pullback: Math.abs(currentPrice - sma20) / sma20 < 0.02,
                        uptrend: sma20 > sma50 && sma50 > sma200,
                        notExtended: ((currentPrice - sma200) / sma200) < 0.20,
                        relativeStrength: relativeStrength > 0,
                        volumeConfirmation: prevVolume < avgVolume && currentVolume > avgVolume,
                    };
                    stop = currentPrice - (2 * atr);
                    pattern = 'Pullback to 20 SMA';
                } else {
                    // SHORT CRITERIA (inverse of long)
                    checks = {
                        breakdown: currentPrice < sma200, // Below long-term support
                        downtrend: sma20 < sma50 && sma50 < sma200, // Bearish alignment
                        failedRally: Math.abs(currentPrice - sma20) / sma20 < 0.02 && currentPrice < sma20, // Near 20 SMA but below it
                        relativeWeakness: relativeStrength < 0, // Underperforming SPY
                        volumeConfirmation: currentVolume > avgVolume, // Volume on down moves
                    };
                    stop = currentPrice + (2 * atr);
                    pattern = 'Failed rally at 20 SMA';
                }

                const passedChecks = Object.values(checks).filter(v => v).length;
                const totalChecks = Object.keys(checks).length;

                if (diagnostic) {
                    const checkLabels = { pullback: 'Near20', uptrend: 'Trend', notExtended: 'NotExt', relativeStrength: 'RS', volumeConfirmation: 'Vol',
                                          breakdown: 'Below200', downtrend: 'Downtrend', failedRally: 'FailRally', relativeWeakness: 'Weak' };
                    const checkStr = Object.entries(checks).map(([k,v]) => `${checkLabels[k]||k}:${v?'‚úì':'‚úó'}`).join(' | ');
                    diagnostics.push({
                        symbol,
                        status: passedChecks >= 4 ? 'üü¢ Signal' : passedChecks === 3 ? 'üü° Pipeline' : '‚ö™ Below',
                        price: currentPrice.toFixed(2),
                        sma20: sma20.toFixed(2),
                        sma50: sma50.toFixed(2),
                        sma200: sma200.toFixed(2),
                        volRatio: (currentVolume / avgVolume).toFixed(2),
                        rs: (relativeStrength > 0 ? '+' : '') + relativeStrength.toFixed(1) + '%',
                        score: `${passedChecks}/${totalChecks}`,
                        checks: checkStr
                    });
                }

                if (passedChecks === 3) {
                    pipeline.push({ symbol, price: currentPrice, checks, passedChecks, totalChecks, pattern, relativeStrength: relativeStrength.toFixed(1), volumeRatio: (currentVolume / avgVolume).toFixed(2) });
                }

                if (passedChecks >= 4) {
                    const risk = Math.abs(currentPrice - stop);
                    const riskAmount = accountSize * (riskPercent / 100);
                    const shares = Math.floor(riskAmount / risk);
                    const positionValue = shares * currentPrice;
                    const target = direction === 'long' ? 
                        currentPrice + (2 * risk) : 
                        currentPrice - (2 * risk);

                    results.push({
                        symbol,
                        direction,
                        price: currentPrice,
                        sma20,
                        sma50,
                        sma200,
                        atr,
                        relativeStrength: relativeStrength.toFixed(1),
                        volumeRatio: (currentVolume / avgVolume).toFixed(2),
                        checks,
                        passedChecks,
                        totalChecks,
                        stop,
                        target,
                        shares,
                        positionValue,
                        riskAmount,
                        pattern
                    });
                }
            }

            document.getElementById('scanningStatus').classList.add('hidden');

            if (results.length === 0 && pipeline.length === 0) {
                document.getElementById('signalResults').innerHTML = `
                    <div class="bg-yellow-50 p-4 rounded border-l-4 border-yellow-500">
                        <p class="text-sm text-yellow-800">No ${direction} signals found and no stocks close to criteria. Market may be in a choppy phase.</p>
                    </div>
                `;
                return;
            }

            // Sort by number of checks passed
            results.sort((a, b) => b.passedChecks - a.passedChecks);

            const directionLabel = direction === 'long' ? 'Long' : 'Short';
            const directionColor = direction === 'long' ? 'green' : 'red';

            let html = `<div class="mb-4 bg-${directionColor}-50 p-4 rounded border-l-4 border-${directionColor}-500">
                <p class="text-sm text-${directionColor}-800 font-medium">Found ${results.length} potential ${directionLabel} signals. Review each for execution tomorrow morning.</p>
            </div>`;

            results.forEach(signal => {
                const strengthColor = signal.passedChecks === 5 ? 'green' : 
                                     signal.passedChecks === 4 ? 'blue' : 'yellow';
                const strength = signal.passedChecks === 5 ? 'Excellent' : 
                                signal.passedChecks === 4 ? 'Good' : 'Marginal';

                const checkLabels = direction === 'long' ? 
                    ['Pullback to 20 SMA', 'Uptrend (20>50>200)', 'Not overextended', 'Relative strength vs SPY', 'Volume confirmation'] :
                    ['Below 200 SMA', 'Downtrend (20<50<200)', 'Failed rally at 20 SMA', 'Relative weakness vs SPY', 'Volume on down move'];

                html += `
                    <div class="signal-card bg-white border-l-4 border-${strengthColor}-500 p-4 rounded shadow">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="text-xl font-bold">${signal.symbol} 
                                    <span class="text-sm ${direction === 'long' ? 'text-green-600' : 'text-red-600'}">${directionLabel}</span>
                                </h3>
                                <p class="text-sm text-gray-600">${signal.pattern} ‚Ä¢ ${signal.passedChecks}/${signal.totalChecks} criteria met</p>
                            </div>
                            <span class="bg-${strengthColor}-100 text-${strengthColor}-800 px-3 py-1 rounded-full text-sm font-medium">
                                ${strength}
                            </span>
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3 text-sm">
                            <div>
                                <span class="text-gray-600">Price:</span>
                                <span class="font-bold ml-1">$${signal.price.toFixed(2)}</span>
                            </div>
                            <div>
                                <span class="text-gray-600">20 SMA:</span>
                                <span class="ml-1">$${signal.sma20.toFixed(2)}</span>
                            </div>
                            <div>
                                <span class="text-gray-600">vs SPY:</span>
                                <span class="ml-1 ${signal.relativeStrength > 0 ? 'text-green-600' : 'text-red-600'}">
                                    ${signal.relativeStrength > 0 ? '+' : ''}${signal.relativeStrength}%
                                </span>
                            </div>
                            <div>
                                <span class="text-gray-600">Vol Ratio:</span>
                                <span class="ml-1">${signal.volumeRatio}x</span>
                            </div>
                        </div>

                        <div class="mb-3 text-xs space-y-1">
                            ${Object.entries(signal.checks).map(([key, value], idx) => `
                                <div class="flex items-center gap-2">
                                    <span class="${value ? 'text-green-600' : 'text-red-600'}">
                                        ${value ? '‚úì' : '‚úó'}
                                    </span>
                                    <span>${checkLabels[idx]}</span>
                                </div>
                            `).join('')}
                        </div>

                        <div class="bg-gray-50 p-3 rounded">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                                <div>
                                    <div class="text-gray-600">Entry</div>
                                    <div class="font-bold">$${signal.price.toFixed(2)}</div>
                                </div>
                                <div>
                                    <div class="text-gray-600">Stop (2√óATR)</div>
                                    <div class="font-bold ${direction === 'long' ? 'text-red-600' : 'text-green-600'}">$${signal.stop.toFixed(2)}</div>
                                </div>
                                <div>
                                    <div class="text-gray-600">2R Mgmt Level</div>
                                    <div class="font-bold ${direction === 'long' ? 'text-green-600' : 'text-red-600'}">$${signal.target.toFixed(2)}</div>
                                </div>
                                <div>
                                    <div class="text-gray-600">Position</div>
                                    <div class="font-bold">${signal.shares} shares</div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-3 pt-3 border-t border-gray-700" id="action-area-signal-${signal.symbol}">
                            <div class="flex gap-2 items-center flex-wrap">
                                <input type="text" id="pass-reason-signal-${signal.symbol}" placeholder="Why take or pass? (one line)" class="flex-1 p-2 text-sm border rounded min-w-0" style="min-width:180px">
                                <button onclick="expandTake('${signal.symbol}','${direction}',${signal.passedChecks},${signal.totalChecks},'signal')" class="bg-green-600 text-white px-4 py-2 rounded text-sm font-medium hover:bg-green-700 whitespace-nowrap">‚úì Take</button>
                                <button onclick="recordPass('${signal.symbol}','${direction}',${signal.price.toFixed(4)},${signal.passedChecks},${signal.totalChecks},'signal')" class="bg-gray-500 text-white px-4 py-2 rounded text-sm font-medium hover:bg-gray-600 whitespace-nowrap">‚úó Pass</button>
                                <button onclick="expandFull('${signal.symbol}','${direction}',${signal.price.toFixed(4)},${signal.passedChecks},${signal.totalChecks},'signal')" class="bg-orange-700 text-white px-4 py-2 rounded text-sm font-medium hover:bg-orange-800 whitespace-nowrap">‚õî Full</button>
                            </div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('signalResults').innerHTML = html;

            // Add pipeline section
            if (pipeline.length > 0) {
                pipeline.sort((a, b) => a.symbol.localeCompare(b.symbol));
                const checkLabels = { pullback: 'Near 20 SMA', uptrend: 'Uptrend', notExtended: 'Not Extended', relativeStrength: 'RS > SPY', volumeConfirmation: 'Volume OK',
                                      breakdown: 'Below 200 SMA', downtrend: 'Downtrend', failedRally: 'Failed Rally', relativeWeakness: 'RS < SPY' };
                let pipeHtml = `
                    <div class="mt-6">
                        <h3 class="text-lg font-bold text-gray-700 mb-3">üìä Pipeline ‚Äî 3/5 Criteria Met (One Away)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                `;
                pipeline.forEach(s => {
                    const checkKeys = Object.keys(s.checks);
                    const checkVals = Object.values(s.checks);
                    const dotRows = checkKeys.map((k, i) => `<div class="flex items-center gap-1 text-xs"><span>${checkVals[i] ? 'üü¢' : '‚ö™'}</span><span class="${checkVals[i] ? 'text-gray-700' : 'text-gray-400'}">${k}</span></div>`).join('');
                    const missing = Object.entries(s.checks).filter(([k,v]) => !v).map(([k]) => checkLabels[k] || k).join(', ');
                    pipeHtml += `
                        <div class="bg-white border border-gray-200 rounded p-3 shadow-sm">
                            <div class="flex justify-between items-start mb-1">
                                <span class="font-bold text-gray-800">${s.symbol}</span>
                                <span class="text-sm text-gray-500">$${s.price.toFixed(2)}</span>
                            </div>
                            <div class="mb-1">${dotRows}</div>
                            <div class="text-xs text-red-500 font-medium">Missing: ${missing}</div>
                            <div class="text-xs text-gray-400 mt-1">RS: ${s.relativeStrength > 0 ? '+' : ''}${s.relativeStrength}% vs SPY &nbsp;|&nbsp; Vol: ${s.volumeRatio}x avg</div>
                            <div class="mt-2 pt-2 border-t border-gray-200" id="action-area-pipeline-${s.symbol}">
                                <input type="text" id="pass-reason-pipeline-${s.symbol}" placeholder="Why take or pass?" class="w-full p-1 text-xs border rounded mb-1">
                                <div class="flex gap-1">
                                    <button onclick="expandTake('${s.symbol}','${direction}',${s.passedChecks},${s.totalChecks},'pipeline')" class="flex-1 bg-green-600 text-white px-2 py-1 rounded text-xs font-medium hover:bg-green-700">‚úì Take</button>
                                    <button onclick="recordPass('${s.symbol}','${direction}',${s.price.toFixed(4)},${s.passedChecks},${s.totalChecks},'pipeline')" class="flex-1 bg-gray-500 text-white px-2 py-1 rounded text-xs font-medium hover:bg-gray-600">‚úó Pass</button>
                                    <button onclick="expandFull('${s.symbol}','${direction}',${s.price.toFixed(4)},${s.passedChecks},${s.totalChecks},'pipeline')" class="flex-1 bg-orange-700 text-white px-2 py-1 rounded text-xs font-medium hover:bg-orange-800">‚õî Full</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                pipeHtml += `</div></div>`;
                document.getElementById('signalResults').innerHTML += pipeHtml;
            } else if (results.length > 0) {
                document.getElementById('signalResults').innerHTML += `
                    <div class="mt-4 text-sm text-gray-400 italic">No stocks at 3/5 criteria in pipeline.</div>
                `;
            } else {
                // No results, show pipeline-only message
                let pipeHtml = `
                    <div class="mb-4 bg-yellow-50 p-4 rounded border-l-4 border-yellow-500">
                        <p class="text-sm text-yellow-800">No full signals found. Pipeline shows stocks at 3/5 criteria ‚Äî watch these.</p>
                    </div>
                    <h3 class="text-lg font-bold text-gray-700 mb-3">üìä Pipeline ‚Äî 3/5 Criteria Met</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                `;
                const checkLabels = { pullback: 'Near 20 SMA', uptrend: 'Uptrend', notExtended: 'Not Extended', relativeStrength: 'RS > SPY', volumeConfirmation: 'Volume OK',
                                      breakdown: 'Below 200 SMA', downtrend: 'Downtrend', failedRally: 'Failed Rally', relativeWeakness: 'RS < SPY' };
                pipeline.sort((a, b) => a.symbol.localeCompare(b.symbol)).forEach(s => {
                    const checkKeys = Object.keys(s.checks);
                    const checkVals = Object.values(s.checks);
                    const dotRows = checkKeys.map((k, i) => `<div class="flex items-center gap-1 text-xs"><span>${checkVals[i] ? 'üü¢' : '‚ö™'}</span><span class="${checkVals[i] ? 'text-gray-700' : 'text-gray-400'}">${k}</span></div>`).join('');
                    const missing = Object.entries(s.checks).filter(([k,v]) => !v).map(([k]) => checkLabels[k] || k).join(', ');
                    pipeHtml += `
                        <div class="bg-white border border-gray-200 rounded p-3 shadow-sm">
                            <div class="flex justify-between items-start mb-1">
                                <span class="font-bold text-gray-800">${s.symbol}</span>
                                <span class="text-sm text-gray-500">$${s.price.toFixed(2)}</span>
                            </div>
                            <div class="mb-1">${dotRows}</div>
                            <div class="text-xs text-red-500 font-medium">Missing: ${missing}</div>
                            <div class="text-xs text-gray-400 mt-1">RS: ${s.relativeStrength > 0 ? '+' : ''}${s.relativeStrength}% vs SPY &nbsp;|&nbsp; Vol: ${s.volumeRatio}x avg</div>
                            <div class="mt-2 pt-2 border-t border-gray-200" id="action-area-pipeline2-${s.symbol}">
                                <input type="text" id="pass-reason-pipeline2-${s.symbol}" placeholder="Why take or pass?" class="w-full p-1 text-xs border rounded mb-1">
                                <div class="flex gap-1">
                                    <button onclick="expandTake('${s.symbol}','${direction}',${s.passedChecks},${s.totalChecks},'pipeline2')" class="flex-1 bg-green-600 text-white px-2 py-1 rounded text-xs font-medium hover:bg-green-700">‚úì Take</button>
                                    <button onclick="recordPass('${s.symbol}','${direction}',${s.price.toFixed(4)},${s.passedChecks},${s.totalChecks},'pipeline2')" class="flex-1 bg-gray-500 text-white px-2 py-1 rounded text-xs font-medium hover:bg-gray-600">‚úó Pass</button>
                                    <button onclick="expandFull('${s.symbol}','${direction}',${s.price.toFixed(4)},${s.passedChecks},${s.totalChecks},'pipeline2')" class="flex-1 bg-orange-700 text-white px-2 py-1 rounded text-xs font-medium hover:bg-orange-800">‚õî Full</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                pipeHtml += `</div>`;
                document.getElementById('signalResults').innerHTML = pipeHtml;
            }
            // Diagnostic table
            if (diagnostic && diagnostics.length > 0) {
                diagnostics.sort((a, b) => {
                    const order = { 'üü¢ Signal': 0, 'üü° Pipeline': 1, '‚ö™ Below': 2, '‚ö†Ô∏è Only': 3, '‚ö†Ô∏è Indicator': 4, '‚ùå Fetch failed': 5 };
                    const aKey = Object.keys(order).find(k => a.status.startsWith(k)) || '‚ö™ Below';
                    const bKey = Object.keys(order).find(k => b.status.startsWith(k)) || '‚ö™ Below';
                    return (order[aKey] ?? 9) - (order[bKey] ?? 9);
                });
                const fetched = diagnostics.filter(d => !d.status.startsWith('‚ùå')).length;
                const failed = diagnostics.filter(d => d.status.startsWith('‚ùå')).length;
                let diagHtml = `
                    <div class="mt-8">
                        <h3 class="text-lg font-bold text-gray-700 mb-1">üî¨ Diagnostic ‚Äî All ${diagnostics.length} Symbols</h3>
                        <p class="text-xs text-gray-500 mb-3">‚úÖ Data fetched: ${fetched} &nbsp;|&nbsp; ‚ùå Fetch failed: ${failed} &nbsp;|&nbsp; üü¢ Signals: ${diagnostics.filter(d=>d.status==='üü¢ Signal').length} &nbsp;|&nbsp; üü° Pipeline: ${diagnostics.filter(d=>d.status==='üü° Pipeline').length}</p>
                        <div class="overflow-x-auto">
                        <table class="w-full text-xs border-collapse">
                            <thead>
                                <tr class="bg-gray-100 text-left">
                                    <th class="p-2 border">Symbol</th>
                                    <th class="p-2 border">Status</th>
                                    <th class="p-2 border">Score</th>
                                    <th class="p-2 border">Price</th>
                                    <th class="p-2 border">SMA20</th>
                                    <th class="p-2 border">SMA50</th>
                                    <th class="p-2 border">SMA200</th>
                                    <th class="p-2 border">Vol/Avg</th>
                                    <th class="p-2 border">RS vs SPY</th>
                                    <th class="p-2 border">Checks</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${diagnostics.map(d => `
                                    <tr class="hover:bg-gray-50 ${d.status === 'üü¢ Signal' ? 'bg-green-50' : d.status === 'üü° Pipeline' ? 'bg-yellow-50' : d.status.startsWith('‚ùå') ? 'bg-red-50' : ''}">
                                        <td class="p-2 border font-bold">${d.symbol}</td>
                                        <td class="p-2 border">${d.status}</td>
                                        <td class="p-2 border font-bold">${d.score}</td>
                                        <td class="p-2 border">$${d.price}</td>
                                        <td class="p-2 border">${d.sma20}</td>
                                        <td class="p-2 border">${d.sma50}</td>
                                        <td class="p-2 border">${d.sma200}</td>
                                        <td class="p-2 border">${d.volRatio}x</td>
                                        <td class="p-2 border">${d.rs}</td>
                                        <td class="p-2 border text-gray-500">${d.checks || ''}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        </div>
                    </div>
                `;
                document.getElementById('signalResults').innerHTML += diagHtml;
            }
        }

        function expandTake(symbol, direction, passedChecks, totalChecks, cardType) {
            // Find the action area for this card
            const actionAreaId = 'action-area-' + cardType + '-' + symbol;
            const el = document.getElementById(actionAreaId);
            if (!el) return;

            const dirLabel = direction === 'short' ? 'Short' : 'Long';
            const stopLabel = direction === 'short' ? 'Stop (above entry)' : 'Stop (below entry)';

            el.innerHTML = `
                <div class="mt-1 space-y-2">
                    <div class="grid grid-cols-3 gap-2">
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">Entry Price</label>
                            <input type="number" id="take-entry-${cardType}-${symbol}" step="0.01" placeholder="0.00" class="w-full p-1 text-sm border rounded">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">${stopLabel}</label>
                            <input type="number" id="take-stop-${cardType}-${symbol}" step="0.01" placeholder="0.00" class="w-full p-1 text-sm border rounded">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">Shares</label>
                            <input type="number" id="take-shares-${cardType}-${symbol}" placeholder="0" class="w-full p-1 text-sm border rounded">
                        </div>
                    </div>
                    <input type="text" id="take-reason-${cardType}-${symbol}" placeholder="Why this trade? (one line)" class="w-full p-1 text-sm border rounded">
                    <div class="flex gap-2">
                        <button onclick="confirmTake('${symbol}','${direction}',${passedChecks},${totalChecks},'${cardType}')" class="flex-1 bg-green-600 text-white px-3 py-1 rounded text-sm font-medium hover:bg-green-700">‚úì Confirm Trade</button>
                        <button onclick="cancelTake('${symbol}','${direction}',${passedChecks},${totalChecks},'${cardType}')" class="bg-gray-600 text-white px-3 py-1 rounded text-sm hover:bg-gray-700">Cancel</button>
                    </div>
                </div>
            `;
        }

        function cancelTake(symbol, direction, passedChecks, totalChecks, cardType) {
            restoreActionArea(symbol, direction, passedChecks, totalChecks, cardType);
        }

        function restoreActionArea(symbol, direction, passedChecks, totalChecks, cardType) {
            const actionAreaId = 'action-area-' + cardType + '-' + symbol;
            const el = document.getElementById(actionAreaId);
            if (!el) return;
            const reasonPlaceholder = cardType === 'signal' ? 'Why take or pass? (one line)' : 'Why take or pass?';
            const inputClass = cardType === 'signal' ? 'flex-1 p-2 text-sm border rounded min-w-0" style="min-width:180px' : 'w-full p-1 text-xs border rounded mb-1';
            const btnClass = cardType === 'signal' ? 'bg-green-600 text-white px-4 py-2 rounded text-sm font-medium hover:bg-green-700 whitespace-nowrap' : 'flex-1 bg-green-600 text-white px-2 py-1 rounded text-xs font-medium hover:bg-green-700';
            const passClass = cardType === 'signal' ? 'bg-gray-500 text-white px-4 py-2 rounded text-sm font-medium hover:bg-gray-600 whitespace-nowrap' : 'flex-1 bg-gray-500 text-white px-2 py-1 rounded text-xs font-medium hover:bg-gray-600';
            const wrapClass = cardType === 'signal' ? 'flex gap-2 items-center flex-wrap' : 'flex gap-1';

            if (cardType === 'signal') {
                el.innerHTML = `
                    <div class="${wrapClass}">
                        <input type="text" id="pass-reason-${cardType}-${symbol}" placeholder="${reasonPlaceholder}" class="flex-1 p-2 text-sm border rounded min-w-0" style="min-width:180px">
                        <button onclick="expandTake('${symbol}','${direction}',${passedChecks},${totalChecks},'${cardType}')" class="${btnClass}">‚úì Take</button>
                        <button onclick="recordPass('${symbol}','${direction}',0,${passedChecks},${totalChecks},'${cardType}')" class="${passClass}">‚úó Pass</button>
                        <button onclick="expandFull('${symbol}','${direction}',0,${passedChecks},${totalChecks},'${cardType}')" class="bg-orange-700 text-white px-4 py-2 rounded text-sm font-medium hover:bg-orange-800 whitespace-nowrap">‚õî Full</button>
                    </div>
                `;
            } else {
                el.innerHTML = `
                    <input type="text" id="pass-reason-${cardType}-${symbol}" placeholder="${reasonPlaceholder}" class="w-full p-1 text-xs border rounded mb-1">
                    <div class="${wrapClass}">
                        <button onclick="expandTake('${symbol}','${direction}',${passedChecks},${totalChecks},'${cardType}')" class="${btnClass}">‚úì Take</button>
                        <button onclick="recordPass('${symbol}','${direction}',0,${passedChecks},${totalChecks},'${cardType}')" class="${passClass}">‚úó Pass</button>
                        <button onclick="expandFull('${symbol}','${direction}',0,${passedChecks},${totalChecks},'${cardType}')" class="flex-1 bg-orange-700 text-white px-2 py-1 rounded text-xs font-medium hover:bg-orange-800">‚õî Full</button>
                    </div>
                `;
            }
        }

        function confirmTake(symbol, direction, passedChecks, totalChecks, cardType) {
            const entry = parseFloat(document.getElementById('take-entry-' + cardType + '-' + symbol)?.value);
            const stop  = parseFloat(document.getElementById('take-stop-'  + cardType + '-' + symbol)?.value);
            const shares = parseInt(document.getElementById('take-shares-' + cardType + '-' + symbol)?.value);
            const reason = document.getElementById('take-reason-' + cardType + '-' + symbol)?.value.trim() || '';

            if (!entry || !stop || !shares) {
                alert('Please fill in entry price, stop, and shares.');
                return;
            }

            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const ts = now.toISOString();

            // Save decision
            const decision = {
                id: Date.now(),
                type: 'decision',
                symbol,
                direction: direction.charAt(0).toUpperCase() + direction.slice(1),
                action: 'take',
                cardType,
                price: entry,
                stop,
                shares,
                passedChecks,
                totalChecks,
                reason,
                date: dateStr,
                timestamp: ts
            };
            decisions.unshift(decision);
            localStorage.setItem('decisions', JSON.stringify(decisions));

            // Save trade
            const trade = {
                id: Date.now() + 1,
                symbol,
                direction: direction.charAt(0).toUpperCase() + direction.slice(1),
                date: dateStr,
                timestamp: ts,
                entry,
                stop,
                shares,
                notes: reason,
                status: 'Open',
                exit: null,
                result: null
            };
            trades.unshift(trade);
            localStorage.setItem('trades', JSON.stringify(trades));

            // Visual confirmation
            const actionAreaEl = document.getElementById('action-area-' + cardType + '-' + symbol);
            if (actionAreaEl) {
                actionAreaEl.innerHTML = `<p class="text-sm font-medium text-green-500">‚úì Trade logged ‚Äî ${shares} shares @ $${entry.toFixed(2)}${reason ? ' ¬∑ "' + reason + '"' : ''}</p>`;
            }
        }

        function recordPass(symbol, direction, price, passedChecks, totalChecks, cardType) {
            const reasonEl = document.getElementById('pass-reason-' + cardType + '-' + symbol);
            const reason = reasonEl ? reasonEl.value.trim() : '';

            const decision = {
                id: Date.now(),
                type: 'decision',
                symbol,
                direction: direction.charAt(0).toUpperCase() + direction.slice(1),
                action: 'pass',
                cardType,
                price: price || null,
                stop: null,
                shares: null,
                passedChecks,
                totalChecks,
                reason,
                date: new Date().toISOString().split('T')[0],
                timestamp: new Date().toISOString()
            };
            decisions.unshift(decision);
            localStorage.setItem('decisions', JSON.stringify(decisions));

            const actionAreaEl = document.getElementById('action-area-' + cardType + '-' + symbol);
            if (actionAreaEl) {
                actionAreaEl.innerHTML = `<p class="text-sm font-medium text-gray-400">‚úó Passed${reason ? ' ¬∑ "' + reason + '"' : ''}</p>`;
            }
        }

        function expandFull(symbol, direction, price, passedChecks, totalChecks, cardType) {
            const actionAreaId = 'action-area-' + cardType + '-' + symbol;
            const el = document.getElementById(actionAreaId);
            if (!el) return;
            const isSignal = cardType === 'signal';
            const inputCls = isSignal ? 'w-full p-2 text-sm border rounded mb-2' : 'w-full p-1 text-xs border rounded mb-1';
            const btnCls = isSignal ? 'text-sm px-3 py-2' : 'text-xs px-2 py-1';
            el.innerHTML = `
                <div class="space-y-1">
                    <p class="text-xs text-orange-400 font-medium">‚õî Account full ‚Äî would you have taken this?</p>
                    <input type="text" id="full-reason-${cardType}-${symbol}" placeholder="Optional note (setup quality, why held others...)" class="${inputCls}">
                    <div class="flex gap-2">
                        <button onclick="recordFull('${symbol}','${direction}',${price},${passedChecks},${totalChecks},'${cardType}','would_take')" class="flex-1 bg-orange-600 text-white rounded font-medium hover:bg-orange-700 ${btnCls}">Would Have Taken</button>
                        <button onclick="recordFull('${symbol}','${direction}',${price},${passedChecks},${totalChecks},'${cardType}','would_pass')" class="flex-1 bg-gray-600 text-white rounded font-medium hover:bg-gray-700 ${btnCls}">Would Have Passed</button>
                        <button onclick="restoreActionArea('${symbol}','${direction}',${passedChecks},${totalChecks},'${cardType}')" class="bg-gray-700 text-white rounded hover:bg-gray-600 ${btnCls} px-2">‚úï</button>
                    </div>
                </div>
            `;
        }

        function recordFull(symbol, direction, price, passedChecks, totalChecks, cardType, wouldHave) {
            const reasonEl = document.getElementById('full-reason-' + cardType + '-' + symbol);
            const reason = reasonEl ? reasonEl.value.trim() : '';
            const decision = {
                id: Date.now(),
                type: 'decision',
                symbol,
                direction: direction.charAt(0).toUpperCase() + direction.slice(1),
                action: 'full',
                wouldHave,   // 'would_take' or 'would_pass'
                cardType,
                price: price || null,
                stop: null,
                shares: null,
                passedChecks,
                totalChecks,
                reason,
                date: new Date().toISOString().split('T')[0],
                timestamp: new Date().toISOString()
            };
            decisions.unshift(decision);
            localStorage.setItem('decisions', JSON.stringify(decisions));
            const actionAreaEl = document.getElementById('action-area-' + cardType + '-' + symbol);
            if (actionAreaEl) {
                const wouldLabel = wouldHave === 'would_take' ? 'Would have taken' : 'Would have passed';
                actionAreaEl.innerHTML = `<p class="text-sm font-medium text-orange-400">‚õî Full ¬∑ ${wouldLabel}${reason ? ' ¬∑ "' + reason + '"' : ''}</p>`;
            }
        }

        // ‚îÄ‚îÄ Goal & tracker state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let goalSettings = JSON.parse(localStorage.getItem('goalSettings') || 'null') || {
            currentSize: 3200,   // current deployed capital
            nextUnlock: 4000     // next even-number trigger
        };
        let reviewMode = false;

        function getNextUnlock(accountSize) {
            // Unlock triggers: 4k, 6k, 8k, 10k... (every even $1k above 4k)
            // Pattern: current deployed is odd (3,5,7...) ‚Üí next unlock is next even
            // But user sets these manually via edit, so just store what they set
            return goalSettings.nextUnlock;
        }

        function updateTracker() {
            const closedTrades = trades.filter(t => t.status === 'Closed' && !t.legacy);
            const wins = closedTrades.filter(t => t.result === 'Win');
            const losses = closedTrades.filter(t => t.result === 'Loss');
            const total = closedTrades.length;
            const winRate = total > 0 ? Math.round((wins.length / total) * 100) : null;

            // Total R
            let totalR = 0;
            closedTrades.forEach(t => {
                const risk = Math.abs(t.entry - t.stop);
                if (risk > 0) {
                    const rMult = (t.exit - t.entry) / risk * (t.direction === 'Short' ? -1 : 1);
                    totalR += rMult;
                }
            });

            // Streak ‚Äî walk back from most recent
            let streak = 0;
            let streakType = null;
            for (let i = 0; i < closedTrades.length; i++) {
                // sort by timestamp desc
                const sorted = [...closedTrades].sort((a,b) => (b.timestamp||b.date).localeCompare(a.timestamp||a.date));
                const t = sorted[i];
                if (i === 0) { streakType = t.result; streak = 1; }
                else if (t.result === streakType) { streak++; }
                else break;
            }

            // Render streak
            const streakEl = document.getElementById('trackerStreak');
            if (total === 0) {
                streakEl.textContent = '‚Äî';
                streakEl.className = 'text-2xl font-bold text-gray-400';
            } else {
                streakEl.textContent = streak + (streakType === 'Win' ? 'W' : 'L');
                streakEl.className = 'text-2xl font-bold ' + (streakType === 'Win' ? 'text-green-400' : 'text-red-400');
            }

            // Render total R
            const rEl = document.getElementById('trackerR');
            rEl.textContent = total === 0 ? '‚Äî' : (totalR >= 0 ? '+' : '') + totalR.toFixed(1) + 'R';
            rEl.className = 'text-2xl font-bold ' + (totalR >= 0 ? 'text-green-400' : 'text-red-400');

            // Render trade count
            document.getElementById('trackerCount').textContent = total === 0 ? '0' : total + ' (' + wins.length + 'W/' + losses.length + 'L)';
            document.getElementById('trackerCount').className = 'text-2xl font-bold text-blue-300';

            // Render win rate
            const wrEl = document.getElementById('trackerWinRate');
            wrEl.textContent = winRate === null ? '‚Äî' : winRate + '%';
            wrEl.className = 'text-2xl font-bold ' + (winRate >= 50 ? 'text-green-400' : winRate !== null ? 'text-yellow-400' : 'text-gray-400');

            // Goal bar
            const current = goalSettings.currentSize;
            const target = goalSettings.nextUnlock;
            // Find the previous unlock (the base we're growing from)
            // Pattern: 3k‚Üí4k, 5k‚Üí6k, 7k‚Üí8k ‚Äî base is always target - 1000
            const base = target - 1000;
            const progress = Math.min(100, Math.max(0, ((current - base) / (target - base)) * 100));
            const remaining = Math.max(0, target - current);

            document.getElementById('trackerBar').style.width = progress.toFixed(1) + '%';
            document.getElementById('trackerUnlockTarget').textContent = '$' + target.toLocaleString();
            document.getElementById('trackerGoalLabel').textContent = '$' + current.toLocaleString() + ' / $' + target.toLocaleString();
            document.getElementById('trackerBarLabel').textContent = remaining > 0
                ? '$' + remaining.toLocaleString() + ' to go until next unlock'
                : 'üéâ Unlock reached! Add $1,000 and update your goal.';

            // Cumulative R bar ‚Äî scales to all-time high, shows current position
            const rBarEl = document.getElementById('trackerRBar');
            const rBarLabel = document.getElementById('trackerRBarLabel');
            const rBarSub = document.getElementById('trackerRBarSub');

            // Build running R history to find all-time high
            let runningR = 0;
            let allTimeHighR = 0;
            const sortedClosed = [...closedTrades].sort((a,b) => (a.timestamp||a.date).localeCompare(b.timestamp||b.date));
            sortedClosed.forEach(t => {
                const risk = Math.abs(t.entry - t.stop);
                if (risk > 0) {
                    const r = (t.exit - t.entry) / risk * (t.direction === 'Short' ? -1 : 1);
                    runningR += r;
                    if (runningR > allTimeHighR) allTimeHighR = runningR;
                }
            });

            if (total === 0) {
                rBarEl.style.width = '0%';
                rBarLabel.textContent = 'No closed trades yet';
                rBarSub.textContent = '';
            } else if (allTimeHighR <= 0) {
                rBarEl.style.background = 'linear-gradient(90deg, #ef4444, #f87171)';
                rBarEl.style.width = '8%';
                rBarLabel.textContent = totalR.toFixed(1) + 'R';
                rBarLabel.className = 'text-xs text-red-400';
                rBarSub.textContent = 'Keep the faith ‚Äî one good trade changes the picture';
            } else {
                const pct = Math.max(2, Math.min(100, (totalR / allTimeHighR) * 100));
                rBarEl.style.width = pct.toFixed(1) + '%';
                rBarEl.style.background = totalR >= 0
                    ? 'linear-gradient(90deg, #10b981, #34d399)'
                    : 'linear-gradient(90deg, #ef4444, #f87171)';
                rBarLabel.textContent = (totalR >= 0 ? '+' : '') + totalR.toFixed(1) + 'R';
                rBarLabel.className = 'text-xs ' + (totalR >= 0 ? 'text-green-400' : 'text-red-400');
                rBarSub.textContent = allTimeHighR > totalR
                    ? 'All-time high: +' + allTimeHighR.toFixed(1) + 'R'
                    : 'At all-time high ‚ú¶';
            }
            // Risk deployed & return per dollar risked
            let totalRiskDeployed = 0;
            let totalPnL = 0;
            closedTrades.forEach(t => {
                const riskPerShare = Math.abs(t.entry - t.stop);
                totalRiskDeployed += riskPerShare * t.shares;
                if (t.pnl !== undefined) {
                    totalPnL += t.pnl;
                } else {
                    const pnl = (t.direction === 'Short' ? -1 : 1) * (t.exit - t.entry) * t.shares;
                    totalPnL += pnl;
                }
            });
            const riskDeployedEl = document.getElementById('trackerRiskDeployed');
            if (total === 0) {
                riskDeployedEl.textContent = '';
            } else {
                const returnPerDollar = totalRiskDeployed > 0 ? (totalPnL / totalRiskDeployed) : 0;
                const sign = returnPerDollar >= 0 ? '+' : '';
                riskDeployedEl.textContent = `Total risk deployed: $${totalRiskDeployed.toFixed(0)} ¬∑ P&L: ${totalPnL >= 0 ? '+' : ''}$${totalPnL.toFixed(2)} ¬∑ Return per $ risked: ${sign}$${returnPerDollar.toFixed(2)}`;
                riskDeployedEl.className = 'text-xs mt-1 ' + (returnPerDollar >= 0 ? 'text-green-600' : 'text-red-500');
            }
        }

        function editGoal() {
            const newCurrent = prompt('Current account size ($):', goalSettings.currentSize);
            if (newCurrent === null) return;
            const newTarget = prompt('Next unlock target ($):', goalSettings.nextUnlock);
            if (newTarget === null) return;
            goalSettings.currentSize = parseFloat(newCurrent) || goalSettings.currentSize;
            goalSettings.nextUnlock = parseFloat(newTarget) || goalSettings.nextUnlock;
            localStorage.setItem('goalSettings', JSON.stringify(goalSettings));

            // Sync screener account size field
            document.getElementById('accountSize').value = goalSettings.currentSize.toFixed(2);
            localStorage.setItem('accountSize', goalSettings.currentSize.toFixed(2));
            updateRiskDisplay();

            updateTracker();
        }

        // ‚îÄ‚îÄ Review mode ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function toggleReviewMode() {
            reviewMode = !reviewMode;
            const btn = document.getElementById('reviewModeBtn');
            if (reviewMode) {
                btn.textContent = 'üìã All Entries';
                btn.className = 'bg-yellow-600 text-white px-6 py-2 rounded hover:bg-yellow-700';
            } else {
                btn.textContent = 'üîç Review Passes & Full';
                btn.className = 'bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700';
            }
            renderTrades();
        }

        function saveOutcome(decisionId, outcome) {
            const d = decisions.find(x => x.id === decisionId);
            if (!d) return;
            d.outcome = outcome;
            localStorage.setItem('decisions', JSON.stringify(decisions));
            renderTrades();
        }

        function showAddTrade() {
            document.getElementById('addTradeForm').classList.remove('hidden');
        }

        function cancelAddTrade() {
            document.getElementById('addTradeForm').classList.add('hidden');
        }

        function saveTrade() {
            const trade = {
                id: Date.now(),
                symbol: document.getElementById('tradeSymbol').value,
                direction: document.getElementById('tradeDirection').value,
                date: document.getElementById('tradeDate').value,
                entry: parseFloat(document.getElementById('tradeEntry').value),
                stop: parseFloat(document.getElementById('tradeStop').value),
                shares: parseInt(document.getElementById('tradeShares').value),
                notes: document.getElementById('tradeNotes').value,
                status: 'Open',
                exit: null,
                result: null,
                legacy: document.getElementById('tradeLegacy').checked
            };

            if (!trade.symbol || !trade.entry || !trade.stop || !trade.shares) {
                alert('Please fill in required fields');
                return;
            }

            trades.unshift(trade);
            localStorage.setItem('trades', JSON.stringify(trades));
            
            document.getElementById('tradeSymbol').value = '';
            document.getElementById('tradeEntry').value = '';
            document.getElementById('tradeStop').value = '';
            document.getElementById('tradeShares').value = '';
            document.getElementById('tradeNotes').value = '';
            document.getElementById('tradeLegacy').checked = false;
            
            cancelAddTrade();
            renderTrades();
        }

        function renderTrades() {
            updateTracker();

            // ‚îÄ‚îÄ Open Positions Panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const openTrades = trades.filter(t => t.status === 'Open');
            const panel = document.getElementById('openPositionsPanel');
            const openList = document.getElementById('openPositionsList');
            const openCount = document.getElementById('openPositionsCount');

            if (openTrades.length > 0) {
                panel.classList.remove('hidden');
                openCount.textContent = openTrades.length + ' position' + (openTrades.length > 1 ? 's' : '');
                openList.innerHTML = openTrades.map(t => {
                    const risk = Math.abs(t.entry - t.stop);
                    const riskPerTrade = risk * t.shares;
                    const posVal = t.entry * t.shares;
                    const dir = (t.direction || '').toLowerCase();
                    const dirColor = dir === 'short' ? 'text-red-400' : 'text-green-400';
                    const dirLabel = dir === 'short' ? '‚ñº Short' : '‚ñ≤ Long';
                    // 2R target
                    const target2R = dir === 'short' ? t.entry - (risk * 2) : t.entry + (risk * 2);
                    return `
                        <div class="rounded-lg p-3" style="background:#0d1f2d; border:1px solid #1e3a5f;">
                            <div class="flex justify-between items-start">
                                <div class="flex items-center gap-3">
                                    <span class="text-lg font-bold text-white">${t.symbol}</span>
                                    <span class="text-xs font-medium ${dirColor}">${dirLabel}</span>
                                    <span class="text-xs text-gray-400">${t.date}</span>
                                    ${t.legacy ? '<span class="text-xs bg-gray-700 text-gray-400 px-1.5 py-0.5 rounded">pre-screener</span>' : ''}
                                </div>
                                <button onclick="closeTrade(${t.id})" class="text-xs bg-blue-700 text-blue-200 px-2 py-1 rounded hover:bg-blue-600">Close ‚Üí</button>
                            </div>
                            <div class="grid grid-cols-4 gap-2 mt-2 text-xs">
                                <div>
                                    <div class="text-gray-500">Entry</div>
                                    <div class="font-bold text-white">$${t.entry.toFixed(2)}</div>
                                </div>
                                <div>
                                    <div class="text-gray-500">Stop</div>
                                    <div class="font-bold text-red-400">$${t.stop.toFixed(2)}</div>
                                </div>
                                <div>
                                    <div class="text-gray-500">2R Target</div>
                                    <div class="font-bold text-green-400">$${target2R.toFixed(2)}</div>
                                </div>
                                <div>
                                    <div class="text-gray-500">Risk</div>
                                    <div class="font-bold text-yellow-400">$${riskPerTrade.toFixed(0)}</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 mt-2 pt-2 border-t border-gray-700">
                                <span class="text-xs text-gray-500">${t.shares} shares ¬∑ $${posVal.toFixed(0)} position</span>
                                ${t.notes ? `<span class="text-xs text-gray-500 italic ml-auto">"${t.notes.split('|')[0].trim()}"</span>` : ''}
                            </div>
                            <div class="flex items-center gap-2 mt-2" id="stop-update-area-${t.id}">
                                <input type="number" id="new-stop-${t.id}" step="0.01" placeholder="Update stop..." class="flex-1 p-1 text-xs border rounded" style="max-width:130px">
                                <button onclick="updateStop(${t.id})" class="text-xs bg-gray-700 text-gray-200 px-2 py-1 rounded hover:bg-gray-600">Update Stop</button>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                panel.classList.add('hidden');
            }

            // Merge decisions and trades into one timeline, newest first
            let allItems = [
                ...trades.map(t => ({ ...t, _kind: 'trade' })),
                ...decisions.map(d => ({ ...d, _kind: 'decision' }))
            ].sort((a, b) => {
                const aTime = a.timestamp || (a.date + 'T00:00:00');
                const bTime = b.timestamp || (b.date + 'T00:00:00');
                return bTime.localeCompare(aTime);
            });

            // Always exclude legacy trades from the main timeline
            allItems = allItems.filter(i => !(i._kind === 'trade' && i.legacy));

            // Review mode: show only Pass and Full decisions
            if (reviewMode) {
                allItems = allItems.filter(i => i._kind === 'decision' && (i.action === 'pass' || i.action === 'full'));
            }

            if (allItems.length === 0) {
                document.getElementById('tradeList').innerHTML = reviewMode
                    ? '<p class="text-gray-500 text-center py-8">No passes or full-account decisions recorded yet.</p>'
                    : '<p class="text-gray-500 text-center py-8">No trades or decisions yet. Run a scan and take or pass on signals.</p>';
                return;
            }

            let html = '';
            allItems.forEach(item => {
                if (item._kind === 'decision') {
                    const d = item;
                    const isTake = d.action === 'take';
                    const isFull = d.action === 'full';
                    const borderColor = isTake ? 'border-green-500' : isFull ? 'border-orange-500' : 'border-gray-500';
                    const badgeBg = isTake ? 'bg-green-900 text-green-300' : isFull ? 'bg-orange-900 text-orange-300' : 'bg-gray-700 text-gray-300';
                    let badgeLabel = isTake ? '‚úì Taken' : isFull ? '‚õî Full' : '‚úó Passed';
                    if (isFull && d.wouldHave) {
                        badgeLabel += d.wouldHave === 'would_take' ? ' ¬∑ Would Take' : ' ¬∑ Would Pass';
                    }
                    const cardTypeLabel = d.cardType === 'pipeline' || d.cardType === 'pipeline2' ? ' ¬∑ Pipeline' : ' ¬∑ Signal';

                    // Review mode outcome field for passes and full decisions
                    let outcomeHtml = '';
                    if (reviewMode && !isTake) {
                        const existing = d.outcome || '';
                        outcomeHtml = `
                            <div class="mt-2 pt-2 border-t border-gray-700">
                                <div class="text-xs text-gray-400 mb-1">How did it play out?</div>
                                <div class="flex gap-2">
                                    <input type="text" id="outcome-${d.id}" value="${existing}" placeholder="e.g. ran +8%, setup failed, never triggered..." class="flex-1 p-1 text-sm border rounded">
                                    <button onclick="saveOutcome(${d.id}, document.getElementById('outcome-${d.id}').value)" class="bg-indigo-600 text-white px-3 py-1 rounded text-xs hover:bg-indigo-700">Save</button>
                                </div>
                                ${existing ? `<p class="text-xs text-indigo-300 mt-1 italic">"${existing}"</p>` : ''}
                            </div>
                        `;
                    }

                    html += `
                        <div class="bg-white border-l-4 ${borderColor} p-4 rounded shadow opacity-90">
                            <div class="flex justify-between items-start mb-1">
                                <div>
                                    <span class="text-base font-bold">${d.symbol}</span>
                                    <span class="text-sm text-gray-500 ml-2">${d.direction}${cardTypeLabel} ¬∑ ${d.passedChecks}/${d.totalChecks} criteria</span>
                                </div>
                                <span class="text-xs px-2 py-1 rounded-full font-medium ${badgeBg}">${badgeLabel}</span>
                            </div>
                            <div class="text-xs text-gray-500 mb-1">${d.date} ¬∑ $${d.price ? d.price.toFixed(2) : '‚Äî'}</div>
                            ${d.reason ? `<p class="text-sm text-gray-300 italic">"${d.reason}"</p>` : '<p class="text-xs text-gray-500 italic">No reason recorded</p>'}
                            ${outcomeHtml}
                        </div>
                    `;
                } else {
                    const trade = item;
                    const risk = Math.abs(trade.entry - trade.stop);
                    const positionValue = trade.shares * trade.entry;
                    const rMultiple = trade.exit ? ((trade.exit - trade.entry) / risk * (trade.direction === 'Short' ? -1 : 1)).toFixed(2) : 'Open';
                    const statusColor = trade.status === 'Open' ? 'blue' :
                                       (trade.result === 'Win' ? 'green' : 'red');
                    html += `
                        <div class="bg-white border-l-4 border-${statusColor}-500 p-4 rounded shadow">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h3 class="text-lg font-bold">${trade.symbol} - ${trade.direction}</h3>
                                    <p class="text-sm text-gray-600">${trade.date}</p>
                                </div>
                                <span class="bg-${statusColor}-100 text-${statusColor}-800 px-3 py-1 rounded-full text-sm font-medium">
                                    ${trade.status}
                                </span>
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm mb-2">
                                <div><span class="text-gray-600">Entry:</span><span class="font-bold ml-1">$${trade.entry.toFixed(2)}</span></div>
                                <div><span class="text-gray-600">Stop:</span><span class="ml-1">$${trade.stop.toFixed(2)}</span></div>
                                <div><span class="text-gray-600">Shares:</span><span class="ml-1">${trade.shares}</span></div>
                                <div><span class="text-gray-600">Position:</span><span class="ml-1">$${positionValue.toFixed(2)}</span></div>
                            </div>
                            ${trade.notes ? `<p class="text-sm text-gray-700 mb-2 italic">"${trade.notes}"</p>` : ''}
                            ${trade.status === 'Open' ? `
                                <button onclick="closeTrade(${trade.id})" class="text-sm text-blue-600 hover:text-blue-800">
                                    Close Trade ‚Üí
                                </button>
                            ` : `
                                <div class="text-sm">
                                    <span class="text-gray-600">Exit:</span>
                                    <span class="font-bold ml-1">$${trade.exit.toFixed(2)}</span>
                                    <span class="ml-3 text-gray-600">R-Multiple:</span>
                                    <span class="font-bold ml-1 ${trade.result === 'Win' ? 'text-green-600' : 'text-red-600'}">
                                        ${rMultiple}R
                                    </span>
                                    ${trade.pnl !== undefined ? `
                                    <span class="ml-3 text-gray-600">P&L:</span>
                                    <span class="font-bold ml-1 ${trade.pnl >= 0 ? 'text-green-600' : 'text-red-600'}">
                                        ${trade.pnl >= 0 ? '+' : ''}$${trade.pnl.toFixed(2)}
                                    </span>` : ''}
                                </div>
                            `}
                        </div>
                    `;
                }
            });

            document.getElementById('tradeList').innerHTML = html;
        }

        function closeTrade(id) {
            const trade = trades.find(t => t.id === id);
            if (!trade) return;

            // Find the trade card and inject an inline close form
            const btn = document.querySelector(`button[onclick="closeTrade(${id})"]`);
            if (!btn) return;

            btn.outerHTML = `
                <div id="close-form-${id}" class="mt-2 space-y-2">
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">Exit Price</label>
                            <input type="number" id="close-exit-${id}" step="0.01" placeholder="0.00" class="w-full p-1 text-sm border rounded">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">Stop at Close (for trailing)</label>
                            <input type="number" id="close-stop-${id}" step="0.01" placeholder="${trade.stop.toFixed(2)}" class="w-full p-1 text-sm border rounded">
                        </div>
                    </div>
                    <input type="text" id="close-note-${id}" placeholder="Exit note (stopped out, 2R raised stop, trailed to 20ma...)" class="w-full p-1 text-sm border rounded">
                    <div class="flex gap-2">
                        <button onclick="confirmClose(${id})" class="flex-1 bg-blue-600 text-white px-3 py-1 rounded text-sm font-medium hover:bg-blue-700">‚úì Confirm Close</button>
                        <button onclick="renderTrades()" class="bg-gray-600 text-white px-3 py-1 rounded text-sm hover:bg-gray-700">Cancel</button>
                    </div>
                </div>
            `;
        }

        function confirmClose(id) {
            const exitPrice = parseFloat(document.getElementById('close-exit-' + id)?.value);
            if (!exitPrice) { alert('Please enter an exit price.'); return; }

            const trade = trades.find(t => t.id === id);
            if (!trade) return;

            trade.exit = exitPrice;
            trade.status = 'Closed';

            const closeNote = document.getElementById('close-note-' + id)?.value.trim() || '';
            if (closeNote) trade.notes = trade.notes ? trade.notes + ' | ' + closeNote : closeNote;

            // P&L: shorts profit when price falls
            const direction = (trade.direction || '').toLowerCase();
            const pnl = direction === 'short'
                ? (trade.entry - trade.exit) * trade.shares
                : (trade.exit - trade.entry) * trade.shares;
            trade.result = pnl > 0 ? 'Win' : 'Loss';
            trade.pnl = pnl;

            // Sync account balance
            const newBalance = Math.round((goalSettings.currentSize + pnl) * 100) / 100;
            goalSettings.currentSize = newBalance;
            localStorage.setItem('goalSettings', JSON.stringify(goalSettings));

            // Keep screener account size field in sync
            document.getElementById('accountSize').value = newBalance.toFixed(2);
            localStorage.setItem('accountSize', newBalance.toFixed(2));
            updateRiskDisplay();

            localStorage.setItem('trades', JSON.stringify(trades));
            renderTrades();
        }

        function updateStop(id) {
            const trade = trades.find(t => t.id === id);
            if (!trade) return;
            const newStop = parseFloat(document.getElementById('new-stop-' + id)?.value);
            if (!newStop) { alert('Enter a new stop price.'); return; }
            trade.stop = newStop;
            localStorage.setItem('trades', JSON.stringify(trades));
            renderTrades();
        }

        function exportTrades() {
            const allItems = [
                ...trades.map(t => ({ ...t, _kind: 'trade' })),
                ...decisions.map(d => ({ ...d, _kind: 'decision' }))
            ].sort((a, b) => {
                const aTime = a.timestamp || (a.date + 'T00:00:00');
                const bTime = b.timestamp || (b.date + 'T00:00:00');
                return bTime.localeCompare(aTime);
            });

            if (allItems.length === 0) {
                alert('No data to export');
                return;
            }

            const headers = ['Date','Type','Action','Symbol','Direction','Card Type','Criteria Met','Price','Stop','Shares','Position Value','Exit Price','R Multiple','Result','Reason / Notes'];

            const escCsv = v => {
                if (v === null || v === undefined) return '';
                const s = String(v);
                return s.includes(',') || s.includes('"') || s.includes('\n') ? '"' + s.replace(/"/g, '""') + '"' : s;
            };

            const rows = allItems.map(item => {
                if (item._kind === 'decision') {
                    return [
                        item.date,
                        'Decision',
                        item.action === 'take' ? 'Take' : item.action === 'full' ? ('Full/' + (item.wouldHave === 'would_take' ? 'WouldTake' : 'WouldPass')) : 'Pass',
                        item.symbol,
                        item.direction,
                        item.cardType,
                        `${item.passedChecks}/${item.totalChecks}`,
                        item.price ? item.price.toFixed(2) : '',
                        item.stop ? item.stop.toFixed(2) : '',
                        item.shares || '',
                        '',
                        '', '', '',
                        item.reason || ''
                    ].map(escCsv).join(',');
                } else {
                    const trade = item;
                    const risk = Math.abs(trade.entry - trade.stop);
                    const positionValue = (trade.shares * trade.entry).toFixed(2);
                    const rMultiple = trade.exit ? ((trade.exit - trade.entry) / risk * (trade.direction === 'Short' ? -1 : 1)).toFixed(2) : '';
                    return [
                        trade.date,
                        'Trade',
                        trade.status === 'Open' ? 'Open' : 'Closed',
                        trade.symbol,
                        trade.direction,
                        'trade',
                        '',
                        trade.entry.toFixed(2),
                        trade.stop.toFixed(2),
                        trade.shares,
                        positionValue,
                        trade.exit ? trade.exit.toFixed(2) : '',
                        rMultiple,
                        trade.result || '',
                        trade.notes || ''
                    ].map(escCsv).join(',');
                }
            });

            const csv = [headers.map(escCsv).join(','), ...rows].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `trading-journal-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function importTrades(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    
                    // Support both old format (array of trades) and new format ({trades, decisions})
                    let importedTrades, importedDecisions;
                    if (Array.isArray(imported)) {
                        importedTrades = imported.filter(i => !i.type || i.type !== 'decision');
                        importedDecisions = imported.filter(i => i.type === 'decision');
                    } else if (imported.trades || imported.decisions) {
                        importedTrades = imported.trades || [];
                        importedDecisions = imported.decisions || [];
                    } else {
                        alert('Invalid backup file format');
                        return;
                    }

                    const confirmed = window.confirm(
                        `Import ${importedTrades.length} trades and ${importedDecisions.length} decisions.\n\n` +
                        `Current: ${trades.length} trades, ${decisions.length} decisions.\n\n` +
                        `OK = Replace all. Cancel = Merge (skip duplicates).`
                    );

                    if (confirmed) {
                        trades = importedTrades;
                        decisions = importedDecisions;
                    } else {
                        const existingTradeIds = new Set(trades.map(t => t.id));
                        trades = [...trades, ...importedTrades.filter(t => !existingTradeIds.has(t.id))];
                        const existingDecisionIds = new Set(decisions.map(d => d.id));
                        decisions = [...decisions, ...importedDecisions.filter(d => !existingDecisionIds.has(d.id))];
                    }

                    localStorage.setItem('trades', JSON.stringify(trades));
                    localStorage.setItem('decisions', JSON.stringify(decisions));
                    renderTrades();
                    alert('Import complete!');
                } catch (error) {
                    alert('Error reading backup file: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function exportBackupJSON() {
            const backup = { trades, decisions };
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `trading-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // ‚îÄ‚îÄ SECTOR RS (Outside View) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const SECTORS = [
            { ticker: 'XLK',  name: 'Technology' },
            { ticker: 'XLV',  name: 'Health Care' },
            { ticker: 'XLF',  name: 'Financials' },
            { ticker: 'XLI',  name: 'Industrials' },
            { ticker: 'XLE',  name: 'Energy' },
            { ticker: 'XLY',  name: 'Cons. Discret.' },
            { ticker: 'XLP',  name: 'Cons. Staples' },
            { ticker: 'XLU',  name: 'Utilities' },
            { ticker: 'XLRE', name: 'Real Estate' },
            { ticker: 'XLB',  name: 'Materials' },
            { ticker: 'XLC',  name: 'Comm. Services' },
        ];

        function sectorRS(closes, spyCloses, lookbackDays) {
            // need at least lookback+1 bars
            if (closes.length < lookbackDays + 1 || spyCloses.length < lookbackDays + 1) return null;
            const sectorReturn = closes[closes.length - 1] / closes[closes.length - 1 - lookbackDays];
            const spyReturn    = spyCloses[spyCloses.length - 1] / spyCloses[spyCloses.length - 1 - lookbackDays];
            return (sectorReturn / spyReturn) * 100; // SPY = 100
        }

        function rsColor(rs) {
            if (rs === null) return '#6b7280';
            const dev = rs - 100;
            // green shades for outperform, red shades for underperform
            if (dev >= 4)   return '#10b981';
            if (dev >= 2)   return '#34d399';
            if (dev >= 0.5) return '#6ee7b7';
            if (dev >= -0.5) return '#9ca3af';
            if (dev >= -2)  return '#f87171';
            if (dev >= -4)  return '#ef4444';
            return '#dc2626';
        }

        async function loadSectorRS() {
            const loading = document.getElementById('sectorLoading');
            const table   = document.getElementById('sectorTable');
            const errEl   = document.getElementById('sectorError');
            const btn     = document.getElementById('sectorRefreshBtn');

            loading.classList.remove('hidden');
            table.classList.add('hidden');
            errEl.classList.add('hidden');
            btn.textContent = '‚Ä¶';
            btn.disabled = true;

            try {
                // Fetch SPY first
                const spyData = await fetchYahooData('SPY');
                if (!spyData) throw new Error('Could not load SPY data');

                const rows = [];
                for (const sector of SECTORS) {
                    const data = await fetchYahooData(sector.ticker);
                    if (!data) { rows.push({ ...sector, rs4: null, rs13: null }); continue; }
                    const rs4  = sectorRS(data.closes, spyData.closes, 20);   // ~4 weeks trading days
                    const rs13 = sectorRS(data.closes, spyData.closes, 65);   // ~13 weeks trading days
                    rows.push({ ...sector, rs4, rs13 });
                }

                // Sort by 4-week RS descending
                rows.sort((a, b) => (b.rs4 ?? 0) - (a.rs4 ?? 0));

                const tbody = document.getElementById('sectorTableBody');
                tbody.innerHTML = '';
                rows.forEach((row, i) => {
                    const rs4Str  = row.rs4  !== null ? row.rs4.toFixed(1)  : '‚Äî';
                    const rs13Str = row.rs13 !== null ? row.rs13.toFixed(1) : '‚Äî';
                    const color4  = rsColor(row.rs4);
                    const color13 = rsColor(row.rs13);

                    // Momentum arrow: is 4-week stronger or weaker than 13-week?
                    let arrow = '‚Äî', arrowColor = '#6b7280';
                    if (row.rs4 !== null && row.rs13 !== null) {
                        const diff = row.rs4 - row.rs13;
                        if (diff > 0.5)       { arrow = '‚Üë'; arrowColor = '#10b981'; }
                        else if (diff < -0.5) { arrow = '‚Üì'; arrowColor = '#f87171'; }
                        else                  { arrow = '‚Üí'; arrowColor = '#9ca3af'; }
                    }

                    const tr = document.createElement('tr');
                    tr.style.borderBottom = '1px solid #2d3748';
                    tr.innerHTML = `
                        <td class="py-1.5 pr-2 text-gray-400 text-xs">${i + 1}</td>
                        <td class="py-1.5 pr-2 text-gray-200 text-xs font-medium">${row.name}</td>
                        <td class="py-1.5 pr-4 text-gray-400 text-xs font-mono">${row.ticker}</td>
                        <td class="py-1.5 pr-4 text-right font-mono text-xs font-bold" style="color:${color4}">${rs4Str}</td>
                        <td class="py-1.5 pr-4 text-right font-mono text-xs" style="color:${color13}">${rs13Str}</td>
                        <td class="py-1.5 text-right font-bold text-sm" style="color:${arrowColor}">${arrow}</td>
                    `;
                    tbody.appendChild(tr);
                });

                loading.classList.add('hidden');
                table.classList.remove('hidden');
                document.getElementById('sectorTimestamp').textContent =
                    'Updated ' + new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            } catch (e) {
                loading.classList.add('hidden');
                errEl.textContent = 'Error loading sector data: ' + e.message;
                errEl.classList.remove('hidden');
            } finally {
                btn.textContent = '‚Üª Refresh';
                btn.disabled = false;
            }
        }

        // Auto-load on startup
        loadSectorRS();

        // Initial load
        updateRiskDisplay();
        renderTrades();
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Signal Screener & Journal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; }
        .tab-active { border-bottom: 3px solid #3b82f6; color: #3b82f6; }
        .signal-card { transition: all 0.2s; }
        .signal-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    </style>
</head>
<body class="bg-gray-50">
    <div class="max-w-7xl mx-auto p-4">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Trading Signal Screener</h1>
            <p class="text-gray-600">Momentum pullback system ‚Ä¢ Volume-confirmed entries ‚Ä¢ Quality over quantity</p>
        </div>

        <!-- Tabs -->
        <div class="bg-white rounded-lg shadow-md mb-6">
            <div class="flex border-b">
                <button onclick="switchTab('screener')" id="tab-screener" class="tab-active px-6 py-3 font-medium">
                    Screener
                </button>
                <button onclick="switchTab('calculator')" id="tab-calculator" class="px-6 py-3 font-medium text-gray-600">
                    Position Sizer
                </button>
                <button onclick="switchTab('journal')" id="tab-journal" class="px-6 py-3 font-medium text-gray-600">
                    Trade Journal
                </button>
                <button onclick="switchTab('rules')" id="tab-rules" class="px-6 py-3 font-medium text-gray-600">
                    Trading Rules
                </button>
            </div>

            <!-- Screener Tab -->
            <div id="content-screener" class="p-6">
                <div class="mb-6 bg-blue-50 p-4 rounded-lg">
                    <h3 class="font-bold mb-2">üîç How This Works</h3>
                    <p class="text-sm text-gray-700 mb-2">Enter stock symbols to analyze. The screener will check real market data and tell you which ones meet your pullback criteria.</p>
                    <p class="text-sm text-gray-700">Review signals after market close, then execute next morning if setup still looks good.</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Direction</label>
                        <select id="scanDirection" class="w-full p-2 border rounded">
                            <option value="long">Long (Pullbacks)</option>
                            <option value="short">Short (Breakdowns)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Account Size ($)</label>
                        <input type="number" id="accountSize" value="3214" class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Risk Mode</label>
                        <select id="riskMode" class="w-full p-2 border rounded">
                            <option value="1">Conservative (1% per trade)</option>
                            <option value="2">Moderate (2% per trade)</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <div class="w-full">
                            <label class="block text-sm font-medium mb-2">Risk per Trade</label>
                            <div class="w-full p-2 border rounded bg-gray-50" id="riskDisplay">$32.14</div>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Symbols to Scan (comma-separated)</label>
                    <input type="text" id="symbolInput" placeholder="AAPL, MSFT, NVDA, GOOGL, META, TSLA, CAT, XLI, etc." class="w-full p-2 border rounded">
                    <p class="text-xs text-gray-500 mt-1">Tip: Check sector ETFs (XLI, XLK, XLF, XLV, etc.) and their top holdings</p>
                </div>

                <div class="flex gap-3 items-center flex-wrap">
                    <button onclick="scanMarket()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                        Scan for Signals
                    </button>
                    <label class="flex items-center gap-2 text-sm text-gray-600 cursor-pointer">
                        <input type="checkbox" id="diagnosticMode" class="w-4 h-4">
                        Diagnostic mode (show raw data for all symbols)
                    </label>
                </div>

                <div id="scanningStatus" class="hidden mt-4 p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded">
                    <p class="text-sm font-medium">Scanning market data... this may take a moment.</p>
                </div>

                <div id="signalResults" class="mt-6 space-y-4">
                    <!-- Signals will appear here -->
                </div>
            </div>

            <!-- Calculator Tab -->
            <div id="content-calculator" class="p-6 hidden">
                <h2 class="text-xl font-bold mb-4">Position Size Calculator</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Symbol</label>
                            <input type="text" id="calcSymbol" class="w-full p-2 border rounded" placeholder="e.g., AAPL">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Entry Price ($)</label>
                            <input type="number" id="calcEntry" step="0.01" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Stop Loss ($)</label>
                            <input type="number" id="calcStop" step="0.01" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Account Size ($)</label>
                            <input type="number" id="calcAccount" value="3214" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Risk per Trade (%)</label>
                            <input type="number" id="calcRisk" value="1" step="0.1" class="w-full p-2 border rounded">
                        </div>
                        <button onclick="calculatePosition()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 w-full">
                            Calculate Position
                        </button>
                    </div>
                    <div id="calcResults" class="bg-gray-50 p-6 rounded-lg">
                        <h3 class="font-bold mb-4">Results</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Risk Amount:</span>
                                <span id="riskAmount" class="font-bold">$0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Risk per Share:</span>
                                <span id="riskPerShare" class="font-bold">$0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Position Size:</span>
                                <span id="positionSize" class="font-bold">0 shares</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Position Value:</span>
                                <span id="positionValue" class="font-bold">$0.00</span>
                            </div>
                            <div class="flex justify-between pt-3 border-t">
                                <span class="text-gray-600">Target (+2R):</span>
                                <span id="target2R" class="font-bold text-green-600">$0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Breakeven Move:</span>
                                <span id="breakeven" class="font-bold text-blue-600">$0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Journal Tab -->
            <div id="content-journal" class="p-6 hidden">
                <h2 class="text-xl font-bold mb-4">Trade Journal</h2>
                <div class="mb-6 flex gap-3 flex-wrap">
                    <button onclick="showAddTrade()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                        + Add Trade
                    </button>
                    <button onclick="exportTrades()" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">
                        üì• Export Backup
                    </button>
                    <button onclick="document.getElementById('importFile').click()" class="bg-purple-600 text-white px-6 py-2 rounded hover:bg-purple-700">
                        üì§ Import Backup
                    </button>
                    <input type="file" id="importFile" accept=".json" style="display: none" onchange="importTrades(event)">
                </div>

                <!-- Add Trade Form -->
                <div id="addTradeForm" class="hidden bg-gray-50 p-6 rounded-lg mb-6">
                    <h3 class="font-bold mb-4">New Trade Entry</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Symbol</label>
                            <input type="text" id="tradeSymbol" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Direction</label>
                            <select id="tradeDirection" class="w-full p-2 border rounded">
                                <option value="Long">Long</option>
                                <option value="Short">Short</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Entry Date</label>
                            <input type="date" id="tradeDate" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Entry Price</label>
                            <input type="number" id="tradeEntry" step="0.01" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Stop Loss</label>
                            <input type="number" id="tradeStop" step="0.01" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Position Size (shares)</label>
                            <input type="number" id="tradeShares" class="w-full p-2 border rounded">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">Setup Notes</label>
                        <textarea id="tradeNotes" rows="3" class="w-full p-2 border rounded" placeholder="What made this a good setup? What was the thesis?"></textarea>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="saveTrade()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                            Save Trade
                        </button>
                        <button onclick="cancelAddTrade()" class="bg-gray-300 text-gray-700 px-6 py-2 rounded hover:bg-gray-400">
                            Cancel
                        </button>
                    </div>
                </div>

                <!-- Trade List -->
                <div id="tradeList" class="space-y-4">
                    <!-- Trades will appear here -->
                </div>
            </div>

            <!-- Rules Tab -->
            <div id="content-rules" class="p-6 hidden">
                <h2 class="text-xl font-bold mb-4">Trading System Rules</h2>
                
                <div class="space-y-6">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-bold mb-2">üìä LONG Entry Setup (All Must Be True)</h3>
                        <ul class="list-disc list-inside space-y-1 text-sm">
                            <li>Price pulls back to or pushes through 20 SMA</li>
                            <li>Stock must be in uptrend (20 > 50 > 200 SMAs)</li>
                            <li>Price within 20% of 200 SMA (not overextended)</li>
                            <li>Relative strength vs SPY positive (outperforming)</li>
                            <li>Sector showing momentum (accelerating strength)</li>
                            <li><strong>Volume confirmation:</strong> Pullback on below-average volume, entry day on above-average volume</li>
                            <li>No earnings within 7 days (before or after)</li>
                        </ul>
                    </div>

                    <div class="bg-red-50 p-4 rounded-lg">
                        <h3 class="font-bold mb-2">üìâ SHORT Entry Setup (All Must Be True)</h3>
                        <ul class="list-disc list-inside space-y-1 text-sm">
                            <li>Price below 200 SMA (broken long-term support)</li>
                            <li>Stock must be in downtrend (20 < 50 < 200 SMAs)</li>
                            <li>Failed rally to 20 SMA (price near but can't break above)</li>
                            <li>Relative weakness vs SPY negative (underperforming)</li>
                            <li>Sector showing weakness</li>
                            <li><strong>Volume confirmation:</strong> Increased volume on down days</li>
                            <li>No earnings within 7 days (avoid binary events)</li>
                        </ul>
                        <p class="text-xs mt-2 text-red-700 font-medium">‚ö†Ô∏è SHORT WARNING: Unlimited risk - be extra strict with 1% rule. Watch for short squeezes around rallies.</p>
                    </div>

                    <div class="bg-green-50 p-4 rounded-lg">
                        <h3 class="font-bold mb-2">üí∞ Position Sizing (SAME FOR LONGS & SHORTS)</h3>
                        <ul class="list-disc list-inside space-y-1 text-sm">
                            <li>Risk 1% of account per trade (conservative mode)</li>
                            <li>Can increase to 2% once confident with 50+ trades logged</li>
                            <li>Stop loss = 2x ATR(20) from entry</li>
                            <li>Position size = (Account √ó Risk%) √∑ (Entry - Stop)</li>
                        </ul>
                    </div>

                    <div class="bg-yellow-50 p-4 rounded-lg">
                        <h3 class="font-bold mb-2">üéØ LONG Exit Management</h3>
                        <ul class="list-disc list-inside space-y-1 text-sm">
                            <li>Hold position to +2R target</li>
                            <li>At +2R: Move stop to +0.5R (lock in half R profit)</li>
                            <li>After hitting +2R: Trail stop at 20 SMA - 1 ATR</li>
                            <li>Exit on stop hit or trend break (price crosses below 20 SMA by more than 1 ATR)</li>
                        </ul>
                    </div>

                    <div class="bg-orange-50 p-4 rounded-lg">
                        <h3 class="font-bold mb-2">üéØ SHORT Exit Management</h3>
                        <ul class="list-disc list-inside space-y-1 text-sm">
                            <li>Hold position to +2R target (price moves DOWN 2R)</li>
                            <li>At +2R: Move stop to +0.5R (lock in half R profit)</li>
                            <li>After hitting +2R: Trail stop at 20 SMA + 1 ATR</li>
                            <li>Exit on stop hit or trend reversal (price breaks above 20 SMA by more than 1 ATR)</li>
                            <li><strong>Critical:</strong> Cover shorts immediately on big market rallies - don't fight the tape</li>
                        </ul>
                    </div>

                    <div class="bg-red-50 p-4 rounded-lg">
                        <h3 class="font-bold mb-2">üõë Risk Rules</h3>
                        <ul class="list-disc list-inside space-y-1 text-sm">
                            <li>Never exceed risk limit per trade (1% or 2%)</li>
                            <li>Maximum 5 concurrent positions TOTAL (longs + shorts combined)</li>
                            <li>No more than 2 positions in same sector</li>
                            <li>Maximum 2 short positions at any time (shorts are higher risk)</li>
                            <li>If 3 consecutive losses, reduce position size by 50% for next 3 trades</li>
                            <li>Never short into strong market rallies - wait for weakness</li>
                        </ul>
                    </div>

                    <div class="bg-purple-50 p-4 rounded-lg">
                        <h3 class="font-bold mb-2">üß† Execution Workflow</h3>
                        <ul class="list-disc list-inside space-y-1 text-sm">
                            <li><strong>After market close:</strong> Run screener for both longs and shorts, review signals, make watchlist</li>
                            <li><strong>Next morning (first 30-60 min):</strong> Watch how signals develop</li>
                            <li><strong>Discretion check:</strong> Does setup still look good? Any overnight news? Pattern still clean?</li>
                            <li><strong>For shorts specifically:</strong> Check short interest (avoid high short interest), check if stock is "hard to borrow"</li>
                            <li><strong>Execute:</strong> If yes, enter manually. If no, pass without regret.</li>
                            <li><strong>Journal it:</strong> Write down why you took or passed on each signal</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize
        document.getElementById('tradeDate').valueAsDate = new Date();
        let trades = JSON.parse(localStorage.getItem('trades') || '[]');

        // Update risk display when account or mode changes
        document.getElementById('accountSize').addEventListener('input', updateRiskDisplay);
        document.getElementById('riskMode').addEventListener('change', updateRiskDisplay);

        function updateRiskDisplay() {
            const account = parseFloat(document.getElementById('accountSize').value) || 0;
            const riskPct = parseFloat(document.getElementById('riskMode').value) || 1;
            const riskAmt = account * (riskPct / 100);
            document.getElementById('riskDisplay').textContent = '$' + riskAmt.toFixed(2);
        }

        function switchTab(tab) {
            ['screener', 'calculator', 'journal', 'rules'].forEach(t => {
                document.getElementById('content-' + t).classList.add('hidden');
                document.getElementById('tab-' + t).classList.remove('tab-active', 'text-blue-600');
                document.getElementById('tab-' + t).classList.add('text-gray-600');
            });
            
            document.getElementById('content-' + tab).classList.remove('hidden');
            document.getElementById('tab-' + tab).classList.add('tab-active', 'text-blue-600');
            document.getElementById('tab-' + tab).classList.remove('text-gray-600');

            if (tab === 'journal') {
                renderTrades();
            }
        }

        // Calculate SMA
        function calculateSMA(prices, period) {
            if (prices.length < period) return null;
            const slice = prices.slice(-period);
            return slice.reduce((sum, p) => sum + p, 0) / period;
        }

        // Calculate ATR
        function calculateATR(highs, lows, closes, period) {
            if (highs.length < period + 1) return null;
            
            let trueRanges = [];
            for (let i = 1; i < highs.length; i++) {
                const high = highs[i];
                const low = lows[i];
                const prevClose = closes[i - 1];
                
                const tr = Math.max(
                    high - low,
                    Math.abs(high - prevClose),
                    Math.abs(low - prevClose)
                );
                trueRanges.push(tr);
            }
            
            const recentTR = trueRanges.slice(-period);
            return recentTR.reduce((sum, tr) => sum + tr, 0) / period;
        }

        async function fetchYahooData(symbol) {
            try {
                const period1 = Math.floor(Date.now() / 1000) - (400 * 24 * 60 * 60);
                const period2 = Math.floor(Date.now() / 1000);
                const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?period1=${period1}&period2=${period2}&interval=1d`;
                const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(yahooUrl)}`;

                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();

                if (!data.chart || !data.chart.result || !data.chart.result[0]) {
                    return null;
                }

                const result = data.chart.result[0];
                const quotes = result.indicators.quote[0];

                return {
                    symbol: symbol,
                    closes: quotes.close.filter(c => c !== null),
                    highs: quotes.high.filter(h => h !== null),
                    lows: quotes.low.filter(l => l !== null),
                    volumes: quotes.volume.filter(v => v !== null),
                    timestamps: result.timestamp
                };
            } catch (error) {
                console.error(`Error fetching ${symbol}:`, error);
                return null;
            }
        }


        async function scanMarket() {
            const symbolInput = document.getElementById('symbolInput').value.trim();
            if (!symbolInput) {
                alert('Please enter symbols to scan');
                return;
            }

            const symbols = symbolInput.split(',').map(s => s.trim().toUpperCase()).filter(s => s);
            const accountSize = parseFloat(document.getElementById('accountSize').value);
            const riskPercent = parseFloat(document.getElementById('riskMode').value);
            const direction = document.getElementById('scanDirection').value;

            document.getElementById('scanningStatus').classList.remove('hidden');
            document.getElementById('signalResults').innerHTML = '';

            const results = [];
            const pipeline = [];
            const diagnostics = [];
            const diagnostic = document.getElementById('diagnosticMode').checked;

            // Fetch SPY for relative strength comparison
            const spyData = await fetchYahooData('SPY');
            let spyReturn = 0;
            if (spyData && spyData.closes.length >= 20) {
                spyReturn = ((spyData.closes[spyData.closes.length - 1] - spyData.closes[spyData.closes.length - 20]) / 
                            spyData.closes[spyData.closes.length - 20]) * 100;
            }

            for (const symbol of symbols) {
                // Rate limit: ~50 calls/min to stay under Finnhub free tier
                if (symbols.indexOf(symbol) > 0 && symbols.indexOf(symbol) % 50 === 0) {
                    document.getElementById('scanningStatus').querySelector('p').textContent = `Pausing briefly to respect API rate limit... (${symbols.indexOf(symbol)}/${symbols.length} scanned)`;
                    await new Promise(r => setTimeout(r, 65000));
                    document.getElementById('scanningStatus').querySelector('p').textContent = 'Scanning market data... this may take a moment.';
                }
                document.getElementById('scanningStatus').querySelector('p').textContent = `Scanning ${symbol} (${symbols.indexOf(symbol)+1}/${symbols.length})...`;
                const data = await fetchYahooData(symbol);
                if (!data) {
                    if (diagnostic) diagnostics.push({ symbol, status: '‚ùå Fetch failed', price: '-', sma20: '-', sma50: '-', sma200: '-', volRatio: '-', rs: '-', score: '-' });
                    continue;
                }

                const closes = data.closes;
                const highs = data.highs;
                const lows = data.lows;
                const volumes = data.volumes;

                if (closes.length < 200) {
                    if (diagnostic) diagnostics.push({ symbol, status: `‚ö†Ô∏è Only ${closes.length} days history`, price: closes[closes.length-1]?.toFixed(2) || '-', sma20: '-', sma50: '-', sma200: '-', volRatio: '-', rs: '-', score: '-' });
                    continue;
                }

                // Calculate indicators
                const currentPrice = closes[closes.length - 1];
                const sma20 = calculateSMA(closes, 20);
                const sma50 = calculateSMA(closes, 50);
                const sma200 = calculateSMA(closes, 200);
                const atr = calculateATR(highs, lows, closes, 20);

                if (!sma20 || !sma50 || !sma200 || !atr) {
                    if (diagnostic) diagnostics.push({ symbol, status: '‚ö†Ô∏è Indicator calc failed', price: currentPrice.toFixed(2), sma20: '-', sma50: '-', sma200: '-', volRatio: '-', rs: '-', score: '-' });
                    continue;
                }

                // Calculate average volume
                const avgVolume = volumes.slice(-20).reduce((sum, v) => sum + v, 0) / 20;
                const currentVolume = volumes[volumes.length - 1];
                const prevVolume = volumes[volumes.length - 2];

                // Calculate relative strength
                const stockReturn = ((closes[closes.length - 1] - closes[closes.length - 20]) / 
                                    closes[closes.length - 20]) * 100;
                const relativeStrength = stockReturn - spyReturn;

                let checks, stop, pattern;

                if (direction === 'long') {
                    // LONG CRITERIA
                    checks = {
                        pullback: Math.abs(currentPrice - sma20) / sma20 < 0.02,
                        uptrend: sma20 > sma50 && sma50 > sma200,
                        notExtended: ((currentPrice - sma200) / sma200) < 0.20,
                        relativeStrength: relativeStrength > 0,
                        volumeConfirmation: prevVolume < avgVolume && currentVolume > avgVolume,
                    };
                    stop = currentPrice - (2 * atr);
                    pattern = 'Pullback to 20 SMA';
                } else {
                    // SHORT CRITERIA (inverse of long)
                    checks = {
                        breakdown: currentPrice < sma200, // Below long-term support
                        downtrend: sma20 < sma50 && sma50 < sma200, // Bearish alignment
                        failedRally: Math.abs(currentPrice - sma20) / sma20 < 0.02 && currentPrice < sma20, // Near 20 SMA but below it
                        relativeWeakness: relativeStrength < 0, // Underperforming SPY
                        volumeConfirmation: currentVolume > avgVolume, // Volume on down moves
                    };
                    stop = currentPrice + (2 * atr);
                    pattern = 'Failed rally at 20 SMA';
                }

                const passedChecks = Object.values(checks).filter(v => v).length;
                const totalChecks = Object.keys(checks).length;

                if (diagnostic) {
                    const checkLabels = { pullback: 'Near20', uptrend: 'Trend', notExtended: 'NotExt', relativeStrength: 'RS', volumeConfirmation: 'Vol',
                                          breakdown: 'Below200', downtrend: 'Downtrend', failedRally: 'FailRally', relativeWeakness: 'Weak' };
                    const checkStr = Object.entries(checks).map(([k,v]) => `${checkLabels[k]||k}:${v?'‚úì':'‚úó'}`).join(' | ');
                    diagnostics.push({
                        symbol,
                        status: passedChecks >= 4 ? 'üü¢ Signal' : passedChecks === 3 ? 'üü° Pipeline' : '‚ö™ Below',
                        price: currentPrice.toFixed(2),
                        sma20: sma20.toFixed(2),
                        sma50: sma50.toFixed(2),
                        sma200: sma200.toFixed(2),
                        volRatio: (currentVolume / avgVolume).toFixed(2),
                        rs: (relativeStrength > 0 ? '+' : '') + relativeStrength.toFixed(1) + '%',
                        score: `${passedChecks}/${totalChecks}`,
                        checks: checkStr
                    });
                }

                if (passedChecks === 3) {
                    pipeline.push({ symbol, price: currentPrice, checks, passedChecks, totalChecks, pattern, relativeStrength: relativeStrength.toFixed(1), volumeRatio: (currentVolume / avgVolume).toFixed(2) });
                }

                if (passedChecks >= 4) {
                    const risk = Math.abs(currentPrice - stop);
                    const riskAmount = accountSize * (riskPercent / 100);
                    const shares = Math.floor(riskAmount / risk);
                    const positionValue = shares * currentPrice;
                    const target = direction === 'long' ? 
                        currentPrice + (2 * risk) : 
                        currentPrice - (2 * risk);

                    results.push({
                        symbol,
                        direction,
                        price: currentPrice,
                        sma20,
                        sma50,
                        sma200,
                        atr,
                        relativeStrength: relativeStrength.toFixed(1),
                        volumeRatio: (currentVolume / avgVolume).toFixed(2),
                        checks,
                        passedChecks,
                        totalChecks,
                        stop,
                        target,
                        shares,
                        positionValue,
                        riskAmount,
                        pattern
                    });
                }
            }

            document.getElementById('scanningStatus').classList.add('hidden');

            if (results.length === 0 && pipeline.length === 0) {
                document.getElementById('signalResults').innerHTML = `
                    <div class="bg-yellow-50 p-4 rounded border-l-4 border-yellow-500">
                        <p class="text-sm text-yellow-800">No ${direction} signals found and no stocks close to criteria. Market may be in a choppy phase.</p>
                    </div>
                `;
                return;
            }

            // Sort by number of checks passed
            results.sort((a, b) => b.passedChecks - a.passedChecks);

            const directionLabel = direction === 'long' ? 'Long' : 'Short';
            const directionColor = direction === 'long' ? 'green' : 'red';

            let html = `<div class="mb-4 bg-${directionColor}-50 p-4 rounded border-l-4 border-${directionColor}-500">
                <p class="text-sm text-${directionColor}-800 font-medium">Found ${results.length} potential ${directionLabel} signals. Review each for execution tomorrow morning.</p>
            </div>`;

            results.forEach(signal => {
                const strengthColor = signal.passedChecks === 5 ? 'green' : 
                                     signal.passedChecks === 4 ? 'blue' : 'yellow';
                const strength = signal.passedChecks === 5 ? 'Excellent' : 
                                signal.passedChecks === 4 ? 'Good' : 'Marginal';

                const checkLabels = direction === 'long' ? 
                    ['Pullback to 20 SMA', 'Uptrend (20>50>200)', 'Not overextended', 'Relative strength vs SPY', 'Volume confirmation'] :
                    ['Below 200 SMA', 'Downtrend (20<50<200)', 'Failed rally at 20 SMA', 'Relative weakness vs SPY', 'Volume on down move'];

                html += `
                    <div class="signal-card bg-white border-l-4 border-${strengthColor}-500 p-4 rounded shadow">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="text-xl font-bold">${signal.symbol} 
                                    <span class="text-sm ${direction === 'long' ? 'text-green-600' : 'text-red-600'}">${directionLabel}</span>
                                </h3>
                                <p class="text-sm text-gray-600">${signal.pattern} ‚Ä¢ ${signal.passedChecks}/${signal.totalChecks} criteria met</p>
                            </div>
                            <span class="bg-${strengthColor}-100 text-${strengthColor}-800 px-3 py-1 rounded-full text-sm font-medium">
                                ${strength}
                            </span>
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3 text-sm">
                            <div>
                                <span class="text-gray-600">Price:</span>
                                <span class="font-bold ml-1">$${signal.price.toFixed(2)}</span>
                            </div>
                            <div>
                                <span class="text-gray-600">20 SMA:</span>
                                <span class="ml-1">$${signal.sma20.toFixed(2)}</span>
                            </div>
                            <div>
                                <span class="text-gray-600">vs SPY:</span>
                                <span class="ml-1 ${signal.relativeStrength > 0 ? 'text-green-600' : 'text-red-600'}">
                                    ${signal.relativeStrength > 0 ? '+' : ''}${signal.relativeStrength}%
                                </span>
                            </div>
                            <div>
                                <span class="text-gray-600">Vol Ratio:</span>
                                <span class="ml-1">${signal.volumeRatio}x</span>
                            </div>
                        </div>

                        <div class="mb-3 text-xs space-y-1">
                            ${Object.entries(signal.checks).map(([key, value], idx) => `
                                <div class="flex items-center gap-2">
                                    <span class="${value ? 'text-green-600' : 'text-red-600'}">
                                        ${value ? '‚úì' : '‚úó'}
                                    </span>
                                    <span>${checkLabels[idx]}</span>
                                </div>
                            `).join('')}
                        </div>

                        <div class="bg-gray-50 p-3 rounded">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                                <div>
                                    <div class="text-gray-600">Entry</div>
                                    <div class="font-bold">$${signal.price.toFixed(2)}</div>
                                </div>
                                <div>
                                    <div class="text-gray-600">Stop (2√óATR)</div>
                                    <div class="font-bold ${direction === 'long' ? 'text-red-600' : 'text-green-600'}">$${signal.stop.toFixed(2)}</div>
                                </div>
                                <div>
                                    <div class="text-gray-600">Target (+2R)</div>
                                    <div class="font-bold ${direction === 'long' ? 'text-green-600' : 'text-red-600'}">$${signal.target.toFixed(2)}</div>
                                </div>
                                <div>
                                    <div class="text-gray-600">Position</div>
                                    <div class="font-bold">${signal.shares} shares</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('signalResults').innerHTML = html;

            // Add pipeline section
            if (pipeline.length > 0) {
                pipeline.sort((a, b) => a.symbol.localeCompare(b.symbol));
                const checkLabels = { pullback: 'Near 20 SMA', uptrend: 'Uptrend', notExtended: 'Not Extended', relativeStrength: 'RS > SPY', volumeConfirmation: 'Volume OK',
                                      breakdown: 'Below 200 SMA', downtrend: 'Downtrend', failedRally: 'Failed Rally', relativeWeakness: 'RS < SPY' };
                let pipeHtml = `
                    <div class="mt-6">
                        <h3 class="text-lg font-bold text-gray-700 mb-3">üìä Pipeline ‚Äî 3/5 Criteria Met (One Away)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                `;
                pipeline.forEach(s => {
                    const checkKeys = Object.keys(s.checks);
                    const checkVals = Object.values(s.checks);
                    const dotRows = checkKeys.map((k, i) => `<div class="flex items-center gap-1 text-xs"><span>${checkVals[i] ? 'üü¢' : '‚ö™'}</span><span class="${checkVals[i] ? 'text-gray-700' : 'text-gray-400'}">${k}</span></div>`).join('');
                    const missing = Object.entries(s.checks).filter(([k,v]) => !v).map(([k]) => checkLabels[k] || k).join(', ');
                    pipeHtml += `
                        <div class="bg-white border border-gray-200 rounded p-3 shadow-sm">
                            <div class="flex justify-between items-start mb-1">
                                <span class="font-bold text-gray-800">${s.symbol}</span>
                                <span class="text-sm text-gray-500">$${s.price.toFixed(2)}</span>
                            </div>
                            <div class="mb-1">${dotRows}</div>
                            <div class="text-xs text-red-500 font-medium">Missing: ${missing}</div>
                            <div class="text-xs text-gray-400 mt-1">RS: ${s.relativeStrength > 0 ? '+' : ''}${s.relativeStrength}% vs SPY &nbsp;|&nbsp; Vol: ${s.volumeRatio}x avg</div>
                        </div>
                    `;
                });
                pipeHtml += `</div></div>`;
                document.getElementById('signalResults').innerHTML += pipeHtml;
            } else if (results.length > 0) {
                document.getElementById('signalResults').innerHTML += `
                    <div class="mt-4 text-sm text-gray-400 italic">No stocks at 3/5 criteria in pipeline.</div>
                `;
            } else {
                // No results, show pipeline-only message
                let pipeHtml = `
                    <div class="mb-4 bg-yellow-50 p-4 rounded border-l-4 border-yellow-500">
                        <p class="text-sm text-yellow-800">No full signals found. Pipeline shows stocks at 3/5 criteria ‚Äî watch these.</p>
                    </div>
                    <h3 class="text-lg font-bold text-gray-700 mb-3">üìä Pipeline ‚Äî 3/5 Criteria Met</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                `;
                const checkLabels = { pullback: 'Near 20 SMA', uptrend: 'Uptrend', notExtended: 'Not Extended', relativeStrength: 'RS > SPY', volumeConfirmation: 'Volume OK',
                                      breakdown: 'Below 200 SMA', downtrend: 'Downtrend', failedRally: 'Failed Rally', relativeWeakness: 'RS < SPY' };
                pipeline.sort((a, b) => a.symbol.localeCompare(b.symbol)).forEach(s => {
                    const checkKeys = Object.keys(s.checks);
                    const checkVals = Object.values(s.checks);
                    const dotRows = checkKeys.map((k, i) => `<div class="flex items-center gap-1 text-xs"><span>${checkVals[i] ? 'üü¢' : '‚ö™'}</span><span class="${checkVals[i] ? 'text-gray-700' : 'text-gray-400'}">${k}</span></div>`).join('');
                    const missing = Object.entries(s.checks).filter(([k,v]) => !v).map(([k]) => checkLabels[k] || k).join(', ');
                    pipeHtml += `
                        <div class="bg-white border border-gray-200 rounded p-3 shadow-sm">
                            <div class="flex justify-between items-start mb-1">
                                <span class="font-bold text-gray-800">${s.symbol}</span>
                                <span class="text-sm text-gray-500">$${s.price.toFixed(2)}</span>
                            </div>
                            <div class="mb-1">${dotRows}</div>
                            <div class="text-xs text-red-500 font-medium">Missing: ${missing}</div>
                            <div class="text-xs text-gray-400 mt-1">RS: ${s.relativeStrength > 0 ? '+' : ''}${s.relativeStrength}% vs SPY &nbsp;|&nbsp; Vol: ${s.volumeRatio}x avg</div>
                        </div>
                    `;
                });
                pipeHtml += `</div>`;
                document.getElementById('signalResults').innerHTML = pipeHtml;
            }
            // Diagnostic table
            if (diagnostic && diagnostics.length > 0) {
                diagnostics.sort((a, b) => {
                    const order = { 'üü¢ Signal': 0, 'üü° Pipeline': 1, '‚ö™ Below': 2, '‚ö†Ô∏è Only': 3, '‚ö†Ô∏è Indicator': 4, '‚ùå Fetch failed': 5 };
                    const aKey = Object.keys(order).find(k => a.status.startsWith(k)) || '‚ö™ Below';
                    const bKey = Object.keys(order).find(k => b.status.startsWith(k)) || '‚ö™ Below';
                    return (order[aKey] ?? 9) - (order[bKey] ?? 9);
                });
                const fetched = diagnostics.filter(d => !d.status.startsWith('‚ùå')).length;
                const failed = diagnostics.filter(d => d.status.startsWith('‚ùå')).length;
                let diagHtml = `
                    <div class="mt-8">
                        <h3 class="text-lg font-bold text-gray-700 mb-1">üî¨ Diagnostic ‚Äî All ${diagnostics.length} Symbols</h3>
                        <p class="text-xs text-gray-500 mb-3">‚úÖ Data fetched: ${fetched} &nbsp;|&nbsp; ‚ùå Fetch failed: ${failed} &nbsp;|&nbsp; üü¢ Signals: ${diagnostics.filter(d=>d.status==='üü¢ Signal').length} &nbsp;|&nbsp; üü° Pipeline: ${diagnostics.filter(d=>d.status==='üü° Pipeline').length}</p>
                        <div class="overflow-x-auto">
                        <table class="w-full text-xs border-collapse">
                            <thead>
                                <tr class="bg-gray-100 text-left">
                                    <th class="p-2 border">Symbol</th>
                                    <th class="p-2 border">Status</th>
                                    <th class="p-2 border">Score</th>
                                    <th class="p-2 border">Price</th>
                                    <th class="p-2 border">SMA20</th>
                                    <th class="p-2 border">SMA50</th>
                                    <th class="p-2 border">SMA200</th>
                                    <th class="p-2 border">Vol/Avg</th>
                                    <th class="p-2 border">RS vs SPY</th>
                                    <th class="p-2 border">Checks</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${diagnostics.map(d => `
                                    <tr class="hover:bg-gray-50 ${d.status === 'üü¢ Signal' ? 'bg-green-50' : d.status === 'üü° Pipeline' ? 'bg-yellow-50' : d.status.startsWith('‚ùå') ? 'bg-red-50' : ''}">
                                        <td class="p-2 border font-bold">${d.symbol}</td>
                                        <td class="p-2 border">${d.status}</td>
                                        <td class="p-2 border font-bold">${d.score}</td>
                                        <td class="p-2 border">$${d.price}</td>
                                        <td class="p-2 border">${d.sma20}</td>
                                        <td class="p-2 border">${d.sma50}</td>
                                        <td class="p-2 border">${d.sma200}</td>
                                        <td class="p-2 border">${d.volRatio}x</td>
                                        <td class="p-2 border">${d.rs}</td>
                                        <td class="p-2 border text-gray-500">${d.checks || ''}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        </div>
                    </div>
                `;
                document.getElementById('signalResults').innerHTML += diagHtml;
            }
            const entry = parseFloat(document.getElementById('calcEntry').value);
            const stop = parseFloat(document.getElementById('calcStop').value);
            const account = parseFloat(document.getElementById('calcAccount').value);
            const riskPct = parseFloat(document.getElementById('calcRisk').value);

            if (!entry || !stop || !account || !riskPct) {
                alert('Please fill in all fields');
                return;
            }

            const riskAmount = account * (riskPct / 100);
            const riskPerShare = Math.abs(entry - stop);
            const shares = Math.floor(riskAmount / riskPerShare);
            const positionValue = shares * entry;
            const target = entry + (2 * riskPerShare);
            const breakeven = entry + (riskPerShare / 2);

            document.getElementById('riskAmount').textContent = '$' + riskAmount.toFixed(2);
            document.getElementById('riskPerShare').textContent = '$' + riskPerShare.toFixed(2);
            document.getElementById('positionSize').textContent = shares + ' shares';
            document.getElementById('positionValue').textContent = '$' + positionValue.toFixed(2);
            document.getElementById('target2R').textContent = '$' + target.toFixed(2);
            document.getElementById('breakeven').textContent = '$' + breakeven.toFixed(2);
        }

        function showAddTrade() {
            document.getElementById('addTradeForm').classList.remove('hidden');
        }

        function cancelAddTrade() {
            document.getElementById('addTradeForm').classList.add('hidden');
        }

        function saveTrade() {
            const trade = {
                id: Date.now(),
                symbol: document.getElementById('tradeSymbol').value,
                direction: document.getElementById('tradeDirection').value,
                date: document.getElementById('tradeDate').value,
                entry: parseFloat(document.getElementById('tradeEntry').value),
                stop: parseFloat(document.getElementById('tradeStop').value),
                shares: parseInt(document.getElementById('tradeShares').value),
                notes: document.getElementById('tradeNotes').value,
                status: 'Open',
                exit: null,
                result: null
            };

            if (!trade.symbol || !trade.entry || !trade.stop || !trade.shares) {
                alert('Please fill in required fields');
                return;
            }

            trades.unshift(trade);
            localStorage.setItem('trades', JSON.stringify(trades));
            
            document.getElementById('tradeSymbol').value = '';
            document.getElementById('tradeEntry').value = '';
            document.getElementById('tradeStop').value = '';
            document.getElementById('tradeShares').value = '';
            document.getElementById('tradeNotes').value = '';
            
            cancelAddTrade();
            renderTrades();
        }

        function renderTrades() {
            if (trades.length === 0) {
                document.getElementById('tradeList').innerHTML = '<p class="text-gray-500 text-center py-8">No trades yet. Start by adding your first trade above.</p>';
                return;
            }

            let html = '';
            trades.forEach(trade => {
                const risk = Math.abs(trade.entry - trade.stop);
                const positionValue = trade.shares * trade.entry;
                const rMultiple = trade.exit ? ((trade.exit - trade.entry) / risk).toFixed(2) : 'Open';
                const statusColor = trade.status === 'Open' ? 'blue' : 
                                   (trade.result === 'Win' ? 'green' : 'red');

                html += `
                    <div class="bg-white border-l-4 border-${statusColor}-500 p-4 rounded shadow">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h3 class="text-lg font-bold">${trade.symbol} - ${trade.direction}</h3>
                                <p class="text-sm text-gray-600">${trade.date}</p>
                            </div>
                            <span class="bg-${statusColor}-100 text-${statusColor}-800 px-3 py-1 rounded-full text-sm font-medium">
                                ${trade.status}
                            </span>
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm mb-2">
                            <div>
                                <span class="text-gray-600">Entry:</span>
                                <span class="font-bold ml-1">$${trade.entry.toFixed(2)}</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Stop:</span>
                                <span class="ml-1">$${trade.stop.toFixed(2)}</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Shares:</span>
                                <span class="ml-1">${trade.shares}</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Position:</span>
                                <span class="ml-1">$${positionValue.toFixed(2)}</span>
                            </div>
                        </div>

                        ${trade.notes ? `<p class="text-sm text-gray-700 mb-2 italic">"${trade.notes}"</p>` : ''}

                        ${trade.status === 'Open' ? `
                            <button onclick="closeTrade(${trade.id})" class="text-sm text-blue-600 hover:text-blue-800">
                                Close Trade ‚Üí
                            </button>
                        ` : `
                            <div class="text-sm">
                                <span class="text-gray-600">Exit:</span>
                                <span class="font-bold ml-1">$${trade.exit.toFixed(2)}</span>
                                <span class="ml-3 text-gray-600">R-Multiple:</span>
                                <span class="font-bold ml-1 ${trade.result === 'Win' ? 'text-green-600' : 'text-red-600'}">
                                    ${rMultiple}R
                                </span>
                            </div>
                        `}
                    </div>
                `;
            });

            document.getElementById('tradeList').innerHTML = html;
        }

        function closeTrade(id) {
            const exitPrice = prompt('Enter exit price:');
            if (!exitPrice) return;

            const trade = trades.find(t => t.id === id);
            if (!trade) return;

            trade.exit = parseFloat(exitPrice);
            trade.status = 'Closed';
            
            const risk = Math.abs(trade.entry - trade.stop);
            const profit = (trade.exit - trade.entry) * trade.shares;
            trade.result = profit > 0 ? 'Win' : 'Loss';

            localStorage.setItem('trades', JSON.stringify(trades));
            renderTrades();
        }

        function exportTrades() {
            if (trades.length === 0) {
                alert('No trades to export');
                return;
            }

            const dataStr = JSON.stringify(trades, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            
            const date = new Date().toISOString().split('T')[0];
            link.download = `trade-journal-backup-${date}.json`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert(`Exported ${trades.length} trades successfully!`);
        }

        function importTrades(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedTrades = JSON.parse(e.target.result);
                    
                    if (!Array.isArray(importedTrades)) {
                        alert('Invalid backup file format');
                        return;
                    }

                    const confirm = window.confirm(
                        `This will import ${importedTrades.length} trades.\n\n` +
                        `Current journal has ${trades.length} trades.\n\n` +
                        `Choose OK to REPLACE current trades, or Cancel to MERGE with current trades.`
                    );

                    if (confirm) {
                        trades = importedTrades;
                    } else {
                        const existingIds = new Set(trades.map(t => t.id));
                        const newTrades = importedTrades.filter(t => !existingIds.has(t.id));
                        trades = [...trades, ...newTrades];
                    }

                    localStorage.setItem('trades', JSON.stringify(trades));
                    renderTrades();
                    alert(`Successfully imported ${importedTrades.length} trades!`);
                } catch (error) {
                    alert('Error reading backup file: ' + error.message);
                }
            };
            reader.readAsText(file);
            
            event.target.value = '';
        }

        // Initial load
        updateRiskDisplay();
        renderTrades();
    </script>
</body>
</html>